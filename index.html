<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FAAâ„¢ | Quantum Protocols Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        /**
         * Firestore Security Rules to enable this application's functionality.
         *
         * IMPORTANT: You need to apply these rules manually in your Firebase project's
         * Firestore -> Rules tab. Replace `YOUR_APP_ID_HERE` with the actual `__app_id`
         * that is provided by the Canvas environment.
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // Allow authenticated users to read and write their own private data
         * match /artifacts/{appId}/users/{userId}/{documents=**} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         *
         * // Allow authenticated users to read and write public data used by this demo app
         * // In a production environment, you might make public data read-only for all,
         * // and only allow authenticated admins to write.
         * match /artifacts/{appId}/public/data/{documents=**} {
         * allow read, write: if request.auth != null;
         * }
         *
         * // Allow authenticated users to read and write dashboard metrics
         * match /artifacts/{appId}/dashboardMetrics/{document=**} {
         * allow read, write: if request.auth != null;
         * }
         * }
         * }
         */

        // Global variables for Firebase (will be populated at runtime by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Default user ID state

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase initialized. User authenticated:", userId);
                    document.getElementById('currentUserIdDisplay').textContent = `User ID: ${userId}`;
                    // Once authenticated, load settings and other user-specific data
                    loadSettings();
                    // Load all Firestore data specific to views
                    renderAllFirestoreData();
                } else {
                    // Sign in anonymously if no user is found
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Anonymous Sign-in or Custom Token failed:", error);
                        window.showCustomModal('Auth Error', 'Failed to authenticate with Firebase. Some features may not work.', true);
                    }
                }
            });

        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            window.showCustomModal('Firebase Error', 'Failed to initialize Firebase. Please check your configuration.', true);
        }

        // Expose Firebase instances globally for use in main script (for simplicity in this single HTML file)
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getUserId = () => userId; // Getter for userId

        // --- Firestore Data Interaction Functions (Globally accessible via window.firestoreXxxx) ---

        /**
         * Fetches a single document from Firestore.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document.
         * @returns {Promise<Object|null>} The document data or null if not found.
         */
        window.firestoreGetDoc = async (collectionPath, docId) => {
            if (!db) { console.error("Firestore not initialized."); return null; }
            try {
                const docRef = doc(db, collectionPath, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.log(`No such document: ${collectionPath}/${docId}`);
                    return null;
                }
            } catch (e) {
                console.error("Error getting document:", e);
                window.showCustomModal('Error', `Failed to load data: ${e.message}`, true);
                return null;
            }
        };

        /**
         * Sets (creates or overwrites) a document in Firestore.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document to set.
         * @param {Object} data - The data to set.
         * @returns {Promise<void>}
         */
        window.firestoreSetDoc = async (collectionPath, docId, data) => {
            if (!db) { console.error("Firestore not initialized."); return; }
            try {
                await setDoc(doc(db, collectionPath, docId), data, { merge: true }); // Use merge to avoid overwriting entire document
                console.log(`Document ${docId} in ${collectionPath} successfully written!`);
            } catch (e) {
                console.error("Error writing document:", e);
                window.showCustomModal('Error', `Failed to save data: ${e.message}`, true);
            }
        };

        /**
         * Adds a new document to a collection with an auto-generated ID.
         * @param {string} collectionPath - The path to the collection.
         * @param {Object} data - The data to add.
         * @returns {Promise<string>} The ID of the newly created document.
         */
        window.firestoreAddDoc = async (collectionPath, data) => {
            if (!db) { console.error("Firestore not initialized."); return null; }
            try {
                const docRef = await addDoc(collection(db, collectionPath), data);
                console.log(`Document written with ID: ${docRef.id} in ${collectionPath}`);
                return docRef.id;
            } catch (e) {
                console.error("Error adding document:", e);
                window.showCustomModal('Error', `Failed to add data: ${e.message}`, true);
                return null;
            }
        };

        /**
         * Updates fields in an existing document.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document to update.
         * @param {Object} data - The fields to update.
         * @returns {Promise<void>}
         */
        window.firestoreUpdateDoc = async (collectionPath, docId, data) => {
            if (!db) { console.error("Firestore not initialized."); return; }
            try {
                await updateDoc(doc(db, collectionPath, docId), data);
                console.log(`Document ${docId} in ${collectionPath} successfully updated!`);
            } catch (e) {
                console.error("Error updating document:", e);
                window.showCustomModal('Error', `Failed to update data: ${e.message}`, true);
            }
        };

        /**
         * Sets up a real-time listener for a collection.
         * @param {string} collectionPath - The path to the collection.
         * @param {function(Array)} callback - Callback function to handle data updates.
         * @returns {function()} An unsubscribe function to stop the listener.
         */
        window.firestoreOnCollectionSnapshot = (collectionPath, callback) => {
            if (!db) { console.error("Firestore not initialized."); return () => {}; }
            const q = collection(db, collectionPath);
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                // Sort data by a common field if needed, e.g., 'name' or 'timestamp'
                // For this app, we'll often sort by name or most recent activity in rendering functions.
                callback(data);
            }, (error) => {
                console.error("Error listening to collection:", error);
                window.showCustomModal('Real-time Error', `Failed to get real-time updates: ${error.message}`, true);
            });
            return unsubscribe;
        };

        /**
         * Sets up a real-time listener for a single document.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document.
         * @param {function(Object|null)} callback - Callback function to handle document updates.
         * @returns {function()} An unsubscribe function to stop the listener.
         */
        window.firestoreOnDocumentSnapshot = (collectionPath, docId, callback) => {
            if (!db) { console.error("Firestore not initialized."); return () => {}; }
            const docRef = doc(db, collectionPath, docId);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    callback(docSnap.data());
                } else {
                    callback(null);
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                window.showCustomModal('Real-time Error', `Failed to get real-time updates for document: ${error.message}`, true);
            });
            return unsubscribe;
        };

        /**
         * Fetches all documents from a collection once.
         * @param {string} collectionPath - The path to the collection.
         * @returns {Promise<Array>} An array of document data.
         */
        window.firestoreGetCollection = async (collectionPath) => {
            if (!db) { console.error("Firestore not initialized."); return []; }
            try {
                const q = collection(db, collectionPath);
                const querySnapshot = await getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (e) {
                console.error("Error getting collection documents:", e);
                window.showCustomModal('Error', `Failed to load data from collection: ${e.message}`, true);
                return [];
            }
        };

        // For deleteDoc function
        window.deleteDoc = deleteDoc;

    </script>
    <style>
        /* Define FAA Quantum Global Color Palette and Base Styles */
        :root {
            /* Dark Mode Defaults */
            --primary-color: #0071e3; /* Apple Blue */
            --secondary-color: #ff8c00; /* Vibrant Orange for Quantum */
            --text-color-light: #f5f5f7; /* Light text on dark backgrounds */
            --text-color-dark: #1d1d1f; /* Dark text on light backgrounds - used for some components that flip colors */
            --bg-color-dark: #1a1a1c; /* Deep black/dark grey */
            --card-bg-dark: #2a2a2e; /* Darker grey for dark cards */
            --border-color-dark: #3a3a3e; /* Subtle dark border */
            --accent-gold: #B8860B; /* Corporate gold accent */
            --status-active: #30d158; /* Green for active */
            --status-pending: #f59e0b; /* Amber for pending */
            --status-draft: #6e6e73; /* Gray for draft */
            --status-error: #ef4444; /* Red for error */

            /* Light Mode Variables (will override dark mode) */
            --light-primary-color: #0071e3;
            --light-secondary-color: #ff8c00;
            --light-text-color-light: #1d1d1f; /* Dark text for light mode body */
            --light-text-color-dark: #1d1d1f; /* Dark text for light mode body content */
            --light-bg-color-dark: #ffffff; /* White background for light mode */
            --light-card-bg-dark: #fcfcfc; /* Off-white for light cards */
            --light-border-color-dark: #e8e8ed; /* Subtle light border */
        }

        /* Base Body Styling - Defaults to dark mode based on root variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-light); /* Main text color based on mode */
            min-height: 100vh;
            display: flex;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            margin: 0;
            padding: 0;
        }

        /* Light Mode specific overrides */
        body.light-mode {
            background-color: var(--light-bg-color-dark);
            color: var(--light-text-color-light);

            /* Overrides for specific components in light mode */
            .sidebar, .panel, .metric-card, .project-card, .chart-container, .custom-modal-content, .company-select-card {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
                box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow */
            }
            .sidebar-header .logo-text {
                color: var(--light-text-color-light); /* Fruitful part darker */
            }
            .nav-list a {
                color: var(--light-text-color-dark); /* Darker nav text */
            }
            .nav-list a:hover {
                background-color: rgba(0, 113, 227, 0.05); /* Lighter hover background */
                color: var(--light-primary-color);
            }
            .nav-list a.active {
                background-color: var(--light-primary-color);
                color: white;
            }
            .nav-icon {
                color: var(--light-secondary-color); /* Orange remains contrast */
            }
            .panel h3, .panel h4 {
                color: var(--light-secondary-color); /* Orange remains contrast */
            }
            .panel p, .project-card p, .api-key-value, .form-control label, .form-control input, .form-control select, .form-control textarea {
                color: var(--light-text-color-dark); /* Darker text for readability */
            }
            .form-control input[type="text"],
            .form-control input[type="email"],
            .form-control input[type="password"],
            .form-control select,
            .form-control textarea {
                background-color: #ebebeb; /* Lighter input fields */
                border-color: #d1d1d1;
                color: var(--light-text-color-light); /* Input text darker */
            }
            .project-card {
                background-color: #f0f0f0; /* Lighter project cards in light mode */
                border-color: #d1d1d1;
            }
            .project-actions button {
                color: white; /* Button text white */
                background-color: var(--light-secondary-color);
            }
            .project-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
                background-color: transparent;
            }
            .project-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .api-key-table th {
                background-color: #e8e8ed;
            }
            .api-key-table tr:hover {
                background-color: #f0f0f0;
            }
            .security-note {
                background-color: rgba(239, 68, 68, 0.08);
                color: #dc2626;
            }
            .template-preview-frame {
                background-color: #f8f8f8; /* Lighter iframe background */
            }
            .editor-container {
                background-color: var(--light-bg-color-dark);
            }
            .editor-header {
                background-color: var(--light-card-bg-dark);
                border-bottom: 1px solid var(--light-border-color-dark);
            }
            .code-editor, .preview-area {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
            }
            .code-editor textarea,
            #editorSectionTopicInput,
            #editorRephraseTextInput,
            #editorGeneratedContentOutput,
            .editor-content-area input {
                background-color: #ebebeb;
                border-color: #d1d1d1;
                color: var(--light-text-color-dark);
            }
            .editor-actions button {
                color: var(--light-text-color-dark); /* Dark button text */
            }
            .editor-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
                background-color: transparent;
            }
            .editor-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .copy-square pre {
                color: var(--light-text-color-dark);
            }
            .toggle-section-btn span {
                color: var(--light-text-color-dark) !important;
            }
        }


        /* Sidebar Styling */
        .sidebar {
            width: 280px; /* Wider sidebar */
            background-color: var(--card-bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--border-color-dark);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto; /* Scrollable sidebar */
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative; /* For theme toggle button positioning */
        }
        .sidebar-header .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-light); /* Icon color changes with theme */
            transition: color 0.3s ease;
        }
        .sidebar-header .theme-toggle:hover {
            color: var(--primary-color);
        }
        .sidebar-header .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #FFFFFF; /* FAA part in white */
            line-height: 1; /* Adjust line height for better alignment */
        }
        .sidebar-header .logo-text span {
            color: var(--secondary-color); /* Quantum Protocols part in orange */
            font-size: 0.8em; /* Make 'Quantum Protocols' slightly smaller relative to 'FAA' */
            letter-spacing: -0.02em; /* Tighter spacing for "Quantum Protocols" */
        }
        .nav-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: var(--text-color-light); /* Nav text color changes with theme */
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .nav-list a:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
        }
        .nav-list a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }
        .nav-list a.active .nav-icon {
            color: white;
        }
        .nav-icon {
            font-size: 1.2rem;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            background-color: var(--bg-color-dark); /* Background changes with theme */
            overflow-y: auto; /* Scrollable main content */
        }

        /* General Panel Styling */
        .panel {
            background-color: var(--card-bg-dark); /* Panel background changes with theme */
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .panel h3, .panel h4 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        .panel h3 { font-size: 1.8rem; }
        .panel h4 { font-size: 1.4rem; }
        .panel p {
            color: var(--text-color-light); /* Paragraph text changes with theme */
            line-height: 1.6;
        }

        /* Metric Cards */
        .metric-card {
            background-color: var(--card-bg-dark); /* Metric card background changes with theme */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .metric-card h4 {
            font-size: 1rem;
            color: var(--text-color-light); /* Metric title changes with theme */
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.1;
        }

        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .project-card {
            background-color: #1a1a1a; /* Project card background (slightly lighter dark) */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #3a3a3e; /* Border based on this card's color */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Light mode specific override for project card background */
        body.light-mode .project-card {
            background-color: #f0f0f0; /* Lighter project cards in light mode */
            border-color: #d1d1d1;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .project-card h4 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .project-card p {
            font-size: 0.9rem;
            color: var(--text-color-light); /* Project card text color changes with theme */
            margin-bottom: 0.4rem;
        }
        /* Light mode specific override for project card text */
        body.light-mode .project-card p {
            color: var(--text-color-dark);
        }
        .project-status {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.8rem;
        }
        .status-live { background-color: var(--status-active); color: white; }
        .status-pending { background-color: var(--status-pending); color: white; }
        .status-draft { background-color: var(--status-draft); color: white; }
        .status-error { background-color: var(--status-error); color: white; }
        .project-actions button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .project-actions button:hover {
            background-color: #e67300; /* Darker orange */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255,140,0,0.3);
        }
        .project-actions button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .project-actions button.secondary:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Form styling */
        .form-control {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-control label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-light); /* Label text changes with theme */
        }
        body.light-mode .form-control label {
            color: var(--text-color-dark); /* Darker labels in light mode */
        }
        .form-control input[type="text"],
        .form-control input[type="email"],
        .form-control input[type="password"],
        .form-control select,
        .form-control textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e; /* Input background changes with theme */
            color: var(--text-color-light); /* Input text color changes with theme */
            font-size: 1rem;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        body.light-mode .form-control input, body.light-mode .form-control select, body.light-mode .form-control textarea {
            background-color: #ebebeb; /* Lighter input fields */
            border-color: #d1d1d1;
            color: var(--text-color-dark);
        }
        .form-control input:focus, .form-control select:focus, .form-control textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }
        .form-action-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .form-action-button:hover {
            background-color: #e67300; /* Darker orange */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255,140,0,0.3);
        }
        .form-action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Analytics Chart specific styling */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            background-color: var(--card-bg-dark); /* Card background for charts */
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for chart background */
        body.light-mode .chart-container {
            background-color: #f0f0f0;
            border-color: #d1d1d1;
        }

        /* API Keys table styling */
        .api-key-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            text-align: left;
        }
        .api-key-table th, .api-key-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color-dark); /* Border changes with theme */
        }
        body.light-mode .api-key-table th, body.light-mode .api-key-table td {
            border-color: var(--light-border-color-dark);
        }
        .api-key-table th {
            background-color: #1a1a1a; /* Header background (slightly lighter dark) */
            color: var(--secondary-color);
            font-weight: 600;
        }
        body.light-mode .api-key-table th {
            background-color: #e8e8ed;
        }
        .api-key-table tr:hover {
            background-color: #3a3a3e; /* Row hover background */
        }
        body.light-mode .api-key-table tr:hover {
            background-color: #f0f0f0;
        }
        .api-key-value {
            font-family: 'monospace';
            font-size: 0.85rem;
            color: var(--text-color-light); /* Key value text changes with theme */
            word-break: break-all;
        }
        body.light-mode .api-key-value {
            color: var(--text-color-dark);
        }
        .security-note {
            background-color: #ef444420; /* Light red background */
            border-left: 4px solid var(--status-error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            color: #ef4444; /* Red text */
            font-size: 0.9rem;
            text-align: left;
        }


        /* Utility for hidden views */
        .view-hidden {
            display: none;
        }

        /* Custom Modal for Alerts */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0; /* Start hidden for fade effect */
            visibility: hidden; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: var(--card-bg-dark); /* Modal background changes with theme */
            color: var(--text-color-light); /* Modal text changes with theme */
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            transform: translateY(-20px); /* Start slightly up for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        body.light-mode .custom-modal-content {
            background-color: var(--light-card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--light-border-color-dark);
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }


        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Template Preview Modal */
        #templatePreviewModal .template-preview-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #templatePreviewModal .template-preview-header h3 {
            color: white;
            margin: 0;
        }
        #templatePreviewModal .close-preview-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #templatePreviewModal .close-preview-btn:hover {
            transform: scale(1.1);
        }
        #templatePreviewModal .template-preview-body {
            padding: 1.5rem;
            background-color: var(--card-bg-dark);
        }
        #templatePreviewModal .template-preview-frame {
            width: 100%;
            height: 400px; /* Fixed height for preview */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #1a1a1c; /* Dark background for iframe */
        }
        #templatePreviewModal .template-preview-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #e67300; /* Darker orange */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--status-draft);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #525257;
            transform: translateY(-1px);
        }

        /* Ecosystem Map Styling */
        .copy-square {
            position: relative;
            background-color: #3a3a3e;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border: 1px solid var(--border-color-dark);
        }
        body.light-mode .copy-square {
            background-color: #e8e8ed;
            border-color: #d1d1d1;
        }
        .copy-square .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }
        .copy-square:hover .copy-button {
            opacity: 1; /* Show on hover */
        }
        .copy-square .copy-button:hover {
            background-color: #005bb5;
        }
        .copy-square pre.conversation-code-block {
            background: none;
            border: none;
            color: var(--text-color-light); /* Ensure text is visible in dark mode */
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
            white-space: pre-wrap; /* Preserve formatting but wrap long lines */
            word-break: break-all; /* Break long words if necessary */
            padding-right: 40px; /* Make space for the copy button */
        }
        body.light-mode .copy-square pre.conversation-code-block {
            color: var(--text-color-dark);
        }

        .toggle-section-btn, .toggle-protocol-section-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color); /* Matches current active nav link or primary color */
            transition: color 0.2s ease;
        }
        body.light-mode .toggle-section-btn, body.light-mode .toggle-protocol-section-btn {
            color: var(--light-primary-color);
        }
        .toggle-section-btn:hover, .toggle-protocol-section-btn:hover {
            color: var(--primary-color);
        }
        .toggle-section-btn i, .toggle-protocol-section-btn i {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
        }
        .toggle-section-btn i.fa-chevron-up, .toggle-protocol-section-btn i.fa-chevron-up {
            transform: rotate(180deg);
        }
        .repo-content-section, .protocol-section-content {
            padding-left: 1rem;
            border-left: 2px solid var(--border-color-dark); /* Indent and show hierarchy */
            margin-top: 1rem;
            padding-top: 0.5rem;
        }
        body.light-mode .repo-content-section, body.light-mode .protocol-section-content {
            border-color: var(--light-border-color-dark);
        }
        .repo-content-section .toggle-section-btn, .protocol-section-content .toggle-protocol-section-btn {
            font-size: 1rem; /* Smaller for nested levels */
            font-weight: 500;
            color: var(--text-color-light); /* Nested sections use lighter text color */
        }
        body.light-mode .repo-content-section .toggle-section-btn, body.light-mode .protocol-section-content .toggle-protocol-section-btn {
            color: var(--text-color-dark);
        }

        /* Ecosystem Map specific section-intro and section-title */
        #ecosystem-roadmap-view .section-title {
            color: var(--secondary-color);
            font-size: 2.2rem;
            font-weight: 800;
        }
        #ecosystem-roadmap-view .section-intro {
            color: var(--text-color-light);
            text-align: center;
            font-size: 1.1rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        body.light-mode #ecosystem-roadmap-view .section-intro {
            color: var(--text-color-dark);
        }

        /* Global Checkout Styling */
        #ecosystem-map-view .step-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        #ecosystem-map-view .checkout-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e;
            color: var(--text-color-light);
            font-size: 1rem;
        }
        #ecosystem-map-view .checkout-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        #ecosystem-map-view .checkout-button:hover {
            background-color: #e67300; /* Darker orange */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255,140,0,0.3);
        }

        /* Editor Workspace Styling */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 5rem); /* Adjust based on main-content padding */
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color-dark);
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #1a1a1a; /* Slightly lighter dark for header */
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color-dark);
        }
        .editor-content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Prevent content overflow */
        }
        .code-editor, .preview-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .code-editor {
            border-right: 1px solid var(--border-color-dark);
        }
        .code-editor textarea {
            background-color: #3a3a3e;
            border: 1px solid var(--border-color-dark);
            color: var(--text-color-light);
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'monospace';
            font-size: 0.9rem;
            flex-grow: 1; /* Allow textarea to take available height */
            min-height: 150px; /* Minimum height for code areas */
            resize: vertical; /* Allow vertical resizing */
        }
        .preview-area iframe {
            width: 100%;
            flex-grow: 1; /* Allow iframe to take available height */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #f8f8f8; /* Light background for iframe content */
            min-height: 300px;
        }
        .editor-actions {
            padding: 1rem 1.5rem;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color-dark);
            gap: 1rem;
        }
        .editor-actions button {
            margin-top: 0; /* Override default margin-top from .form-action-button */
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
        }

        /* Settings Tab Navigation */
        .settings-tab-btn {
            padding: 0.75rem 1.25rem;
            background-color: transparent;
            border: none;
            color: var(--text-color-light);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        body.light-mode .settings-tab-btn {
            color: var(--text-color-dark);
        }
        .settings-tab-btn:hover {
            color: var(--primary-color);
            border-color: rgba(0, 113, 227, 0.5);
        }
        .settings-tab-btn.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Company Selection Card for Settings */
        .company-select-card {
            background-color: #2a2a2e; /* Darker grey background */
            border: 1px solid #3a3a3e; /* Dark border */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        body.light-mode .company-select-card {
            background-color: #f0f0f0; /* Lighter background in light mode */
            border-color: #d1d1d1;
        }
        .company-select-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .company-details-section {
            background-color: #2a2a2e;
            border: 1px solid #3a3a3e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-top: 2.5rem;
        }
        body.light-mode .company-details-section {
            background-color: #fcfcfc;
            border-color: #e8e8ed;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .editor-content-area {
                flex-direction: row;
            }
            .code-editor, .preview-area {
                border-right: 1px solid var(--border-color-dark); /* Separator in desktop view */
            }
            .preview-area {
                border-right: none; /* No right border on last item */
            }
        }
        @media (max-width: 767px) {
            .editor-content-area {
                flex-direction: column;
            }
            .code-editor, .preview-area {
                border-bottom: 1px solid var(--border-color-dark);
            }
            .preview-area {
                border-bottom: none;
            }
            .editor-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }


        /* Responsive Mobile Layout */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
                border-right: none;
                border-bottom: 1px solid var(--border-color-dark);
                flex-direction: row; /* Horizontal layout for mobile nav */
                justify-content: space-around;
                flex-wrap: wrap; /* Allow nav items to wrap */
                position: sticky; /* Keep sidebar visible on scroll */
                top: 0;
                z-index: 40; /* Ensure it's above main content when scrolling */
            }
            .sidebar-header {
                width: 100%;
                margin-bottom: 1rem;
                display: flex; /* Make it a flex container to center logo */
                justify-content: center; /* Center logo horizontally */
                align-items: center;
                height: auto; /* Allow height to adjust */
            }
            .sidebar-header .theme-toggle {
                position: relative; /* Adjust position for mobile, remove absolute positioning */
                top: auto;
                right: auto;
                margin-left: 1rem; /* Add some spacing */
            }
            .sidebar-header .logo-text {
                font-size: 1.5rem; /* Adjust font size for mobile */
                letter-spacing: -0.01em;
            }
            .sidebar-header .logo-text span {
                font-size: 0.8em; /* Keep relative size */
            }
            .nav-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            .nav-list a {
                margin: 0.2rem 0.3rem; /* Tighter spacing for mobile nav items */
                padding: 0.5rem 0.6rem;
                font-size: 0.75rem; /* Smaller font size */
                gap: 0.5rem; /* Smaller gap for icon/text */
                flex-grow: 1; /* Allow items to stretch to fill space */
                justify-content: center; /* Center text within small buttons */
            }
            .nav-list a .nav-icon {
                font-size: 0.9rem; /* Smaller icon on mobile */
                margin-right: 0.2rem;
            }

            .main-content {
                padding: 1rem; /* Reduced padding for main content */
            }
            .panel {
                padding: 1.5rem; /* Reduced panel padding */
                margin-bottom: 1.5rem;
            }
            .panel h3 { font-size: 1.5rem; margin-bottom: 1rem;}
            .panel h4 { font-size: 1.2rem; margin-bottom: 0.8rem;}
            .metric-card p { font-size: 2rem; }
            .project-grid {
                grid-template-columns: 1fr; /* Stack projects on mobile */
                gap: 1rem;
            }
            .project-actions button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.3rem;
                margin-top: 0.5rem;
            }
            .form-control {
                margin-bottom: 1rem;
            }
            .form-control input, .form-control select, .form-control textarea {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .form-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .chart-container {
                height: 250px; /* Shorter charts on mobile */
            }
            .api-key-table th, .api-key-table td {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            .api-key-value {
                font-size: 0.7rem;
            }
            .security-note {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 class="logo-text">FAAâ„¢ | <span>Quantum Protocols</span></h2>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i> <!-- Default to sun icon for dark mode -->
            </button>
        </div>
        <nav class="nav-list">
            <a href="#dashboard" class="active" data-view="dashboard">
                <i class="fas fa-chart-line nav-icon"></i> Dashboard
            </a>
            <a href="#protocols" data-view="protocols">
                <i class="fas fa-atom nav-icon"></i> Protocols
            </a>
            <a href="#deployments" data-view="deployments">
                <i class="fas fa-cloud-upload-alt nav-icon"></i> Deployments
            </a>
            <a href="#new-protocol" data-view="new-protocol">
                <i class="fas fa-plus-circle nav-icon"></i> New Protocol
            </a>
            <a href="#quantum-insights" data-view="quantum-insights">
                <i class="fas fa-brain nav-icon"></i> Quantum Insights
            </a>
            <a href="#ecosystem-roadmap" data-view="ecosystem-roadmap">
                <i class="fas fa-map-marked-alt nav-icon"></i> Ecosystem Roadmap
            </a>
            <a href="#pricing" data-view="pricing">
                <i class="fas fa-dollar-sign nav-icon"></i> Pricing & Billing
            </a>
            <a href="#api-keys" data-view="api-keys">
                <i class="fas fa-key nav-icon"></i> API Keys
            </a>
            <a href="#settings" data-view="settings">
                <i class="fas fa-cog nav-icon"></i> Settings
            </a>
            <a href="#login" data-view="login">
                <i class="fas fa-sign-in-alt nav-icon"></i> Sign In
            </a>
            <a href="#signup" data-view="signup">
                <i class="fas fa-user-plus nav-icon"></i> Sign Up
            </a>
        </nav>
        <div class="mt-auto text-center text-xs text-gray-500 pt-4 border-t border-gray-700">
            <span id="currentUserIdDisplay">User ID: Loading...</span>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Dashboard Home View -->
        <section id="dashboard-view" class="view">
            <div class="panel">
                <h3>Welcome Back, Quantum Protocols Engineer!</h3>
                <p class="mb-4">Your FAAâ„¢ Quantum Protocols Dashboard provides comprehensive insights and management tools for your quantum operations and deployed protocols across the global network.</p>
                <button class="form-action-button" onclick="showView('new-protocol')">
                    <i class="fas fa-plus-circle mr-2"></i> Deploy New Protocol
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <div class="metric-card">
                    <h4>Active Connections</h4>
                    <p id="activeConnectionsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Quantum Operations</h4>
                    <p id="quantumOperationsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Protocol Efficiency</h4>
                    <p id="protocolEfficiencyPercentage">0%</p>
                </div>
            </div>

            <!-- FAA Metadata & Compliance -->
            <div class="panel">
                <h3 class="mb-4">FAA Metadata & Compliance</h3>
                <div>
                    <ul class="text-gray-400 space-y-1 text-sm">
                        <li><span class="font-semibold text-white">Product ID:</span> QUA-QUA-4409</li>
                        <li><span class="font-semibold text-white">VaultID:</span> VAULT-O420</li>
                        <li><span class="font-semibold text-white">Signal Echo Layer:</span> Layer Alpha v1.3</li>
                        <li><span class="font-semibold text-white">Deployment Zone:</span> Zone B 10</li>
                        <li><span class="font-semibold text-white">Security Rating:</span> FAA-SEC A</li>
                        <li><span class="font-semibold text-white">Active Nodes:</span> 984</li>
                        <li><span class="font-semibold text-white">Last Audit:</span> 2025-06-29</li>
                        <li><span class="font-semibold text-white">Compliance Status:</span> Active & Certified</li>
                    </ul>
                </div>
            </div>

            <!-- Real-Time Metrics Overview -->
            <div class="panel">
                <h3 class="mb-4">Real-Time Metrics Overview</h3>
                <div>
                    <ul class="text-gray-400 space-y-1 text-sm">
                        <li><span class="font-semibold text-white">Current Pulse Activity:</span> 21,299 pulses/sec</li>
                        <li><span class="font-semibold text-white">Data Volume Processed (24h):</span> 34.60 TB</li>
                        <li><span class="font-semibold text-white">Latency Average:</span> 15 ms</li>
                    </ul>
                    <h4 class="font-semibold text-lg mt-4 mb-2 text-white">VaultTraceâ„¢ Ledger Entries:</h4>
                    <ul class="text-gray-400 space-y-1 text-sm">
                        <li>#343 - QUANT Pulse Tx - <span class="text-yellow-600 font-medium">Pending</span></li>
                        <li>#8359 - QUANT Data Sync - <span class="text-green-600 font-medium">Completed</span></li>
                        <li>#6234 - Node Actuation Confirm - <span class="text-blue-600 font-medium">Active</span></li>
                        <li>#4667 - VaultTrace Audit - <span class="text-green-600 font-medium">Passed</span></li>
                    </ul>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Security Incident Trend Chart -->
                <div class="panel">
                    <h3 class="mb-4">Security Incident Trend</h3>
                    <div class="chart-container">
                        <canvas id="securityIncidentsChart"></canvas>
                    </div>
                </div>

                <!-- Protocol Performance Chart -->
                <div class="panel">
                    <h3 class="mb-4">Protocol Performance Over Time</h3>
                    <div class="chart-container">
                        <canvas id="protocolPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Alerts with Anomaly Investigator -->
            <div class="panel">
                <h3 class="mb-4">Recent Alerts</h3>
                <div class="space-y-3">
                    <div class="bg-red-50 border border-red-200 text-red-700 p-3 rounded-md text-sm flex items-center justify-between">
                        <div>
                            <span class="font-semibold mr-2">CRITICAL:</span> Protocol A Anomaly Detected.
                        </div>
                        <button class="form-action-button text-xs px-2 py-1 ml-4" onclick="window.investigateAnomaly('CRITICAL: Protocol A Anomaly Detected.', this)">
                            <i class="fas fa-search"></i> âœ¨ Investigate
                        </button>
                        <p id="alertStatus-1" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 p-3 rounded-md text-sm flex items-center justify-between">
                        <div>
                            <span class="font-semibold mr-2">WARNING:</span> High Latency on Network Segment B.
                        </div>
                        <button class="form-action-button text-xs px-2 py-1 ml-4" onclick="window.investigateAnomaly('WARNING: High Latency on Network Segment B.', this)">
                            <i class="fas fa-search"></i> âœ¨ Investigate
                        </button>
                        <p id="alertStatus-2" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded-md text-sm flex items-center justify-between">
                        <div>
                            <span class="font-semibold mr-2">INFO:</span> New Firmware Update Available.
                        </div>
                        <button class="form-action-button text-xs px-2 py-1 ml-4" onclick="window.investigateAnomaly('INFO: New Firmware Update Available.', this)">
                            <i class="fas fa-search"></i> âœ¨ Investigate
                        </button>
                        <p id="alertStatus-3" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Protocols View -->
        <section id="protocols-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-atom mr-2"></i> Core Brands & Subnodes</h3>
                <p class="mb-4 text-gray-400">Explore the foundational quantum protocols and their integrated subnodes within the FAA ecosystem.</p>
                <div id="protocolBrandsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Protocol brands and subnodes will be rendered here by JS -->
                    <p class="text-center text-gray-400 col-span-full">Loading protocol data...</p>
                </div>
            </div>
        </section>

        <!-- Deployments View (Adapted from Projects) -->
        <section id="deployments-view" class="view view-hidden">
            <div class="panel">
                <h3>Your Quantum Protocol Deployments</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <input type="text" id="deploymentSearch" placeholder="Search deployments..." class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                    <select id="deploymentFilterStatus" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                        <option value="all">All Statuses</option>
                        <option value="live">Live</option>
                        <option value="pending">Pending</option>
                        <option value="draft">Draft</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div id="deploymentsList" class="project-grid">
                    <!-- Deployments will be loaded here -->
                    <p class="text-center text-gray-400">Loading deployments...</p>
                </div>
                <div class="text-center mt-6">
                    <button id="loadMoreDeployments" class="form-action-button"><i class="fas fa-sync-alt mr-2"></i> Load More Deployments</button>
                </div>
            </div>
        </section>

        <!-- New Protocol View (Adapted from New Project) -->
        <section id="new-protocol-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-plus-circle mr-2"></i> Deploy a New Quantum Protocol</h3>
                <form id="newProtocolForm">
                    <div class="form-control">
                        <label for="protocolName">Protocol Name</label>
                        <input type="text" id="protocolName" name="protocolName" placeholder="e.g. Entangled Key Distribution v2.0" required>
                    </div>

                    <div class="form-control">
                        <label for="protocolType">Protocol Type</label>
                        <select id="protocolType" name="protocolType" required>
                            <option value="">Loading types...</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="protocolDescription">Protocol Description</label>
                        <div class="flex items-center space-x-2">
                            <textarea id="protocolDescription" name="protocolDescription" rows="5" class="flex-grow" placeholder="Describe the protocol's function, quantum mechanism, and intended use..."></textarea>
                            <button type="button" id="generateProtocolDescriptionBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ AI Generate Description
                            </button>
                        </div>
                        <p id="protocolDescriptionStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="quantumConcept">Core Quantum Concept</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="quantumConcept" placeholder="e.g., Quantum Entanglement, Superposition, Qubit Teleportation">
                            <button type="button" id="generateProtocolIdeaBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ AI Protocol Idea
                            </button>
                        </div>
                        <p id="protocolIdeaStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="deploymentZone">Deployment Zone</label>
                        <select id="deploymentZone" name="deploymentZone">
                            <option value="Global Quantum Grid">Global Quantum Grid</option>
                            <option value="Regional Network Cluster">Regional Network Cluster</option>
                            <option value="Secure Local Enclave">Secure Local Enclave</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="vaultClaim">Enable VaultClaimâ„¢ Auto-Registry?</label>
                        <select id="vaultClaim" name="vaultClaim">
                            <option value="yes">Yes â€“ Register this protocol</option>
                            <option value="no">No â€“ Just save draft</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Create Protocol</button>
                    <p class="text-gray-500 text-sm mt-4">Protocols will be saved in your FAA Quantum workspace and can be deployed to the Global Quantum Grid upon registration.</p>
                </form>
            </div>

            <!-- Quantum Code Development Tools (NEW) -->
            <div class="panel mt-8">
                <h3><i class="fas fa-terminal mr-2"></i> Quantum Code Development Tools</h3>
                <p class="mb-4 text-gray-400">Leverage AI to generate, optimize, and understand quantum code snippets or pseudo-code for your protocols.</p>

                <div class="form-control">
                    <label for="quantumCodeDescription">Quantum Code Description (for generation)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="quantumCodeDescription" placeholder="e.g., Qiskit for Bell state creation, Cirq for quantum Fourier transform">
                        <button type="button" id="generateQuantumCodeBtn" class="form-action-button text-xs px-3 py-2">
                            âœ¨ Generate Quantum Code
                        </button>
                    </div>
                    <p id="quantumCodeGenStatus" class="text-xs text-gray-400 mt-1"></p>
                </div>

                <div class="form-control">
                    <label for="quantumCodeArea">Quantum Code Area (Input/Output)</label>
                    <textarea id="quantumCodeArea" rows="10" class="flex-grow" placeholder="Paste your quantum code here, or it will be generated here..."></textarea>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <button type="button" id="optimizeQuantumCodeBtn" class="form-action-button text-xs px-3 py-2">
                            <i class="fas fa-magic"></i> âœ¨ Optimize Quantum Code
                        </button>
                        <button type="button" id="explainQuantumCodeBtn" class="form-action-button secondary text-xs px-3 py-2">
                            <i class="fas fa-question-circle"></i> âœ¨ Explain Quantum Code
                        </button>
                    </div>
                    <p id="quantumCodeOptExplainStatus" class="text-xs text-gray-400 mt-1"></p>
                    <div id="quantumCodeExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </section>

        <!-- Quantum Insights View (Adapted from Analytics) -->
        <section id="quantum-insights-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-brain mr-2"></i> Quantum Performance Insights</h3>
                <p class="mb-4 text-gray-400">Deep analytics into your deployed quantum protocols and overall network performance.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container">
                        <canvas id="protocolDeploymentTrendsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="quantumResourceAllocationChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h4>Qubit Engagement Metrics</h4>
                    <div class="chart-container">
                        <canvas id="qubitActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ecosystem Roadmap View (NEW) -->
        <section id="ecosystem-roadmap-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">FAAâ„¢ Quantum Ecosystem Roadmap</h2>
                <p class="section-intro mb-8">This roadmap outlines the strategic phases and key milestones for the development and expansion of the FAAâ„¢ Quantum Protocols ecosystem. Each phase builds upon the last, driving towards a fully integrated and globally accessible quantum network.</p>
                
                <div id="roadmapContainer" class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                    <h3 class="text-xl font-bold mb-4 text-orange-400">Roadmap Overview:</h3>
                    <div class="space-y-4">
                        <!-- Roadmap phases and milestones will be rendered here by JS -->
                        <p class="text-gray-400">Loading roadmap data...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing & Billing View (Adapted from Ecosystem Map - Global Payment) -->
        <section id="pricing-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">Quantum Protocols Pricing & Global Payment</h2>
                <p class="section-intro mb-8">Access transparent pricing for all FAAâ„¢ Quantum Protocols and manage your billing with our secure, unified payment system. All transactions are handled by **VaultPayâ„¢** and **VaultClaimâ„¢** for automated licensing.</p>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-800">Pricing Structure</h3>
                        <div class="flex items-center">
                            <label for="currency-select" class="mr-2 text-sm text-gray-600">Convert to:</label>
                            <select id="currency-select" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-gray-800">
                                <option value="USD" selected>USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CAD">CAD</option>
                                <option value="AUD">AUD</option>
                                <option value="ZAR">ZAR</option>
                                <!-- Add more currencies as needed -->
                            </select>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <!-- Starter Node -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Starter Node</h4>
                            <p class="text-gray-700 mb-2">Ideal for small quantum research teams and pilot projects. Access essential features and secure basic data synchronization.</p>
                            <p class="text-3xl font-extrabold text-blue-600"><span id="starter-price">96.00</span> <span id="starter-currency">USD</span>/mo</p>
                            <ul class="list-disc pl-5 text-gray-600 text-sm mt-2">
                                <li>Essential quantum features</li>
                                <li>Basic data sync</li>
                                <li>Community support</li>
                            </ul>
                        </div>
                        <!-- Pro Grid -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Pro Grid</h4>
                            <p class="text-gray-700 mb-2">Designed for growing firms needing advanced quantum capabilities. Includes 7 core features and enhanced performance.</p>
                            <p class="text-3xl font-extrabold text-green-600"><span id="pro-price">348.00</span> <span id="pro-currency">USD</span>/mo</p>
                            <ul class="list-disc pl-5 text-gray-600 text-sm mt-2">
                                <li>Advanced quantum features</li>
                                <li>High-volume data processing</li>
                                <li>Priority support</li>
                                <li>Expanded analytics</li>
                            </ul>
                        </div>
                        <!-- Enterprise Omni-Sync -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Enterprise Omni-Sync</h4>
                            <p class="text-gray-700 mb-2">For large organizations requiring full VaultQuantum access, custom integrations, and dedicated resources.</p>
                            <p class="text-3xl font-extrabold text-purple-600">Custom pricing</p>
                            <ul class="list-disc pl-5 text-gray-600 text-sm mt-2">
                                <li>Full VaultQuantum access</li>
                                <li>Dedicated account management</li>
                                <li>Custom integrations</li>
                                <li>24/7 Premium Support</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Quantum Checkout: Seamless Transactions</h2>
                    <p class="section-intro mb-8">The FAAâ„¢ Global Quantum payment system is unified, secure, and automated. Integrated with **VaultPayâ„¢** for secure transactions and **VaultClaimâ„¢** for automated licensing, this system ensures a frictionless experience for customers globally.</p>

                    <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-6 text-orange-400">Experience the Global Checkout Flow:</h3>
                        
                        <div id="checkout-step-1">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">1</span> Item Selection</h4>
                            <p class="text-gray-300 mb-4">Your selected item: **QuantumMeshâ„¢ Enterprise License**</p>
                            <p class="text-gray-300 mb-4">Price: **$99,999.00 USD** (One-time license fee)</p>
                            <button class="checkout-button" onclick="showCheckoutStep(2)">Proceed to Checkout</button>
                        </div>

                        <div id="checkout-step-2" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">2</span> Payment Information</h4>
                            <p class="text-gray-300 mb-4">Enter your secure payment details for **VaultPayâ„¢** processing.</p>
                            <input type="text" id="cardNumber" placeholder="Card Number (e.g., 4111 XXXX XXXX 1111)" class="checkout-input mb-3">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="expiryDate" placeholder="MM/YY" class="checkout-input">
                                <input type="text" id="cvc" placeholder="CVC" class="checkout-input">
                            </div>
                            <button class="checkout-button w-full" onclick="processPayment()">Process Payment via VaultPayâ„¢</button>
                            <p id="paymentStatus" class="text-red-400 mt-2 text-sm hidden">Payment processing...</p>
                        </div>

                        <div id="checkout-step-3" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">3</span> Order Confirmation & Licensing</h4>
                            <p class="text-gray-300 mb-4">Your order is confirmed! Licensing is being secured via **VaultClaimâ„¢**.</p>
                            <p id="orderStatus" class="text-green-400 mb-4">Status: **VaultClaimâ„¢ License Activated!**</p>
                            <button class="checkout-button w-full" onclick="resetCheckout()">Complete & Return to Dashboard</button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- API Keys View -->
        <section id="api-keys-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-key mr-2"></i> Consolidated API Key Index (FAAâ„¢ Quantum Protocols)</h3>
                <p class="mb-4 text-gray-400">This document provides a comprehensive list of all API keys and credentials identified across your provided canvases and chat interactions. It explicitly lists every canvas where each key was embedded or mentioned.</p>

                <div class="security-note">
                    <strong>Important Security Note:</strong> Directly embedding API keys and sensitive credentials in client-side HTML or JavaScript is generally not recommended for production environments. This exposes your keys, making them vulnerable to misuse. For deployed applications, it is strongly advised to use a secure backend server to proxy your API requests and manage these keys via environment variables or a dedicated secrets management system.
                </div>

                <table class="api-key-table">
                    <thead>
                        <tr>
                            <th>API/Service</th>
                            <th>Key/Credential Details</th>
                            <th>Embedded Locations</th>
                        </tr>
                    </thead>
                    <tbody id="apiKeysTableBody">
                        <!-- API keys will be loaded here -->
                        <tr><td colspan="3" class="text-center text-gray-400">Loading API keys...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings View -->
        <section id="settings-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-cog mr-2"></i> My Settings</h3>

                <!-- Settings Navigation -->
                <div class="flex border-b border-gray-700 mb-6">
                    <button class="settings-tab-btn active" data-settings-tab="profile">Profile</button>
                    <button class="settings-tab-btn" data-settings-tab="preferences">Protocol Preferences</button>
                    <button class="settings-tab-btn" data-settings-tab="security">Security</button>
                    <button class="settings-tab-btn" data-settings-tab="domains">Network & Cloud Services</button>
                </div>

                <!-- Profile Sub-view -->
                <div id="settings-profile" class="settings-sub-view">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Profile</h4>
                        <div class="form-control">
                            <label for="displayName">Display Name</label>
                            <input type="text" id="displayName" value="">
                        </div>

                        <div class="form-control">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="">
                        </div>

                        <button class="form-action-button" onclick="saveUserProfile()">Update Profile</button>
                    </section>
                </div>

                <!-- Protocol Preferences Sub-view -->
                <div id="settings-preferences" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Protocol Preferences</h4>
                        <div class="form-control">
                            <label for="defaultDeploymentZone">Default Deployment Zone</label>
                            <select id="defaultDeploymentZone">
                                <option value="Global Quantum Grid">Global Quantum Grid</option>
                                <option value="Regional Network Cluster">Regional Network Cluster</option>
                                <option value="Secure Local Enclave">Secure Local Enclave</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label for="autoVaultClaimSetting">Auto-Enable VaultClaimâ„¢ on Save?</label>
                            <select id="autoVaultClaimSetting">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>

                        <button class="form-action-button" onclick="saveProtocolPreferences()">Save Preferences</button>
                    </section>
                </div>

                <!-- Security Sub-view -->
                <div id="settings-security" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Security</h4>
                        <div class="form-control">
                            <label for="password">Change Password</label>
                            <input type="password" id="password" placeholder="New Password">
                        </div>

                        <div class="form-control">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm Password">
                        </div>

                        <button class="form-action-button" onclick="window.showCustomModal('Password Updated!', 'Your password has been changed securely. (Simulation)')">Update Password</button>
                    </section>
                </div>

                <!-- Network & Cloud Services Sub-view -->
                <div id="settings-domains" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>Quantum DNS Zone Management (Cloudflare Integrated)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your quantum network's DNS records (A, CNAME, TXT) with direct Cloudflare integration for secure routing.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th>TTL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dnsRecordsTableBody">
                                <!-- DNS records will be loaded here -->
                                <tr><td colspan="5" class="text-center text-gray-400">Loading DNS records...</td></tr>
                            </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                             <input type="text" id="dnsRecordTypeInput" placeholder="DNS Type (e.g., A, CNAME, MX)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs max-w-[200px]">
                            <button class="form-action-button text-sm px-3 py-2 bg-purple-600 hover:bg-purple-700" id="explainDnsBtn">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain DNS Type
                            </button>
                            <button class="form-action-button text-sm px-3 py-2" onclick="addDnsRecord()">
                                <i class="fas fa-plus mr-1"></i> Add Record
                            </button>
                        </div>
                        <p id="dnsExplainStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="dnsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>Quantum Node Management (Vercel Integrated for Silent Deployments)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your primary quantum nodes and add-on nodes. Deployed silently via Vercel integration.</p>
                        <ul id="nodeList" class="list-disc list-inside text-gray-200 mb-4">
                            <!-- Nodes will be loaded here -->
                            <p class="text-center text-gray-400">Loading nodes...</p>
                        </ul>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newNodeName" placeholder="Add New Node (e.g., node-alpha.quantum)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" onclick="addNode()">
                                <i class="fas fa-plus mr-1"></i> Add Node
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <input type="text" id="newAddonNodeName" placeholder="Add Add-on Node (e.g., sub-node.main-node)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <select id="addonNodeTarget" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                                <option value="">Select Primary Node</option>
                            </select>
                            <button class="form-action-button text-sm px-3 py-2" onclick="addAddonNode()">
                                <i class="fas fa-plus mr-1"></i> Add Add-on
                            </button>
                        </div>
                        <button class="form-action-button mt-4 bg-blue-600 hover:bg-blue-700" onclick="window.showCustomModal('Silent Deploy Initiated', 'Initiating silent deployment across Cloudflare and Vercel... (Simulation)')">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Deploy in Silence
                        </button>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Quantum Communication Channels (Powered by Zoho Mail)</h4>
                        <p class="text-gray-400 text-sm mb-4">Create and manage quantum-secured communication channels.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Channel Address</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quantumChannelsTableBody">
                                <!-- Quantum Channels will be loaded here -->
                                <tr><td colspan="3" class="text-center text-gray-400">Loading channels...</td></tr>
                            </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newChannelPrefix" placeholder="New channel (e.g., secure-comm)" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <span class="text-gray-200">@</span>
                            <input type="text" id="newChannelDomain" placeholder="quantum.faa.zone" value="quantum.faa.zone" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" id="createChannelBtn">
                                <i class="fas fa-plus mr-1"></i> Create Channel
                            </button>
                        </div>
                        <p id="channelDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mt-8">
                        <h4 class="text-orange-400 mb-4">Company Infrastructure Setup & Details (Quantum Sector)</h4>
                        <p class="text-gray-300 mb-4">Access the comprehensive setup details for any company in the Quantum Protocols sector. Select a company below to reveal its granular configurations. **No troubleshooting or helpline needed**.</p>
                        
                        <div id="settingsCompanySelectionGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            <!-- Company selection cards for settings will be rendered here -->
                            <p class="text-center text-gray-400 col-span-full">Loading company data...</p>
                        </div>

                        <div id="settingsCompanyDetailsOutput" class="company-details-section hidden">
                            <!-- Dynamic company details will be rendered here when a company is selected -->
                        </div>
                    </section>

                </div>

                <p class="text-gray-500 text-sm mt-4">All changes are synced to your FAAâ„¢ Quantum Vault and stored with encrypted VaultClaim credentials.</p>
            </div>
        </section>

        <!-- Login View -->
        <section id="login-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-sign-in-alt mr-2"></i> Sign In to FAAâ„¢ Quantum</h3>
                <form id="loginForm">
                    <div class="form-control">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" value="quantum.user@example.com" required>
                    </div>
                    <div class="form-control">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="password123" required>
                    </div>
                    <button type="submit" class="form-action-button">Login</button>
                    <p class="text-gray-500 text-sm mt-4">Don't have an account? <a href="#signup" class="text-blue-500 hover:underline" onclick="showView('signup')">Sign Up</a></p>
                </form>
            </div>
        </section>

        <!-- Sign Up View -->
        <section id="signup-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-user-plus mr-2"></i> Join FAAâ„¢ Quantum</h3>
                <form id="signupForm">
                    <div class="form-control">
                        <label for="signupName">Display Name</label>
                        <input type="text" id="signupName" placeholder="Your Display Name" required>
                    </div>
                    <div class="form-control">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-control">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div class="form-control">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <button type="submit" class="form-action-button">Sign Up</button>
                    <p class="text-gray-500 text-sm mt-4">Already have an account? <a href="#login" class="text-blue-500 hover:underline" onclick="showView('login')">Sign In</a></p>
                </form>
            </div>
        </section>
    </main>

    <!-- Anomaly Investigator Modal (NEW) -->
    <div id="anomalyInvestigatorModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="anomalyInvestigatorTitle">Quantum Anomaly Investigation</h3>
                <button class="close-preview-btn" onclick="window.hideAnomalyInvestigatorModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p id="anomalyReportText" class="text-gray-400 text-sm mb-2"></p>
                <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                    <p class="text-gray-200 whitespace-pre-wrap" id="anomalyInvestigationOutput"></p>
                </div>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="window.hideAnomalyInvestigatorModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Protocol Idea Modal -->
    <div id="protocolIdeaModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="protocolIdeaModalTitle">AI Protocol Idea</h3>
                <button class="close-preview-btn" onclick="hideProtocolIdeaModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">Review the AI-generated idea below:</p>
                <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                    <p class="text-gray-200 mb-2"><strong>Protocol Name:</strong> <span id="ideaProtocolName"></span></p>
                    <p class="text-gray-200 mb-2"><strong>Description:</strong> <span id="ideaProtocolDescription"></span></p>
                    <p class="text-gray-200"><strong>Suggested Type:</strong> <span id="ideaSuggestedType"></span></p>
                </div>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="applyProtocolIdeaBtn"><i class="fas fa-check-circle mr-2"></i> Apply Idea to Form</button>
                    <button class="btn-secondary" onclick="hideProtocolIdeaModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Protocol Summary Modal (NEW) -->
    <div id="protocolSummaryModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="protocolSummaryTitle">Protocol Summary</h3>
                <button class="close-preview-btn" onclick="hideProtocolSummaryModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="protocolSummaryText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideProtocolSummaryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Channel Draft Modal (NEW) -->
    <div id="channelDraftModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="channelDraftTitle">Draft Channel Message</h3>
                <button class="close-preview-btn" onclick="hideChannelDraftModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">To: <span id="channelDraftTo"></span></p>
                <div class="form-control">
                    <label for="channelPurposeInput" class="text-white text-sm mb-1">Purpose of Message</label>
                    <input type="text" id="channelPurposeInput" placeholder="e.g., Quantum Network Alert, Protocol Update, Secure Communication" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                </div>
                <button type="button" id="generateChannelDraftBtn" class="form-action-button text-xs px-3 py-2">
                    âœ¨ Generate Draft
                </button>
                <p id="channelDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                <textarea id="generatedChannelDraftOutput" rows="10" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Your AI-generated message draft will appear here..." readonly></textarea>
                <div class="template-preview-actions">
                    <button class="btn-primary" onclick="document.execCommand('copy'); window.showCustomModal('Message Copied', 'Message draft copied to clipboard!', true);">Copy to Clipboard</button>
                    <button class="btn-secondary" onclick="hideChannelDraftModal()">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Custom Modal for Alerts (standard app alerts) -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="customModalMessage"></p>
        </div>
    </div>

    <script>
        // --- Centralized Data Store for FAA Quantum Dashboard ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const FAA_QUANTUM_DATA = {
            dashboard: {
                activeConnections: 1234,
                quantumOperations: 5678901,
                protocolEfficiency: 98.7,
                securityIncidents: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Security Incidents',
                        data: [5, 8, 3, 10, 6, 12],
                        backgroundColor: '#EF4444',
                        borderColor: '#EF4444',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                protocolPerformance: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4', 'Q5'],
                    datasets: [
                        { label: 'Protocol A', data: [4000, 3000, 2000, 2780, 1890], borderColor: '#8884d8', backgroundColor: 'rgba(136, 132, 216, 0.2)', fill: true, tension: 0.4 },
                        { label: 'Protocol B', data: [2400, 1398, 9800, 3908, 4800], borderColor: '#82ca9d', backgroundColor: 'rgba(130, 202, 157, 0.2)', fill: true, tension: 0.4 },
                        { label: 'Protocol C', data: [2000, 2210, 2290, 2000, 2181], borderColor: '#ffc658', backgroundColor: 'rgba(255, 198, 88, 0.2)', fill: true, tension: 0.4 },
                    ]
                }
            },
            protocols: { // These are the core brands and subnodes
                coreBrands: [
                    {
                        name: "QuantumMeshâ„¢â„¢",
                        icon: "fas fa-network-wired", // Network icon
                        description: "A cutting-edge FAA.ZONE solution designed for secure and scalable quantum data integration with the global PulseGrid.",
                        features: [
                            "Direct integration with FAA Professional Services Mesh",
                            "Advanced data sync with QSync",
                            "Real-time compliance validation via VaultLinkâ„¢ (quantum specific)",
                            "Scalable architecture for x24 node expansion",
                            "Predictive analytics module for QuantumMeshâ„¢ performance",
                            "API access for seamless interoperability",
                            "AI-driven anomaly detection and fraud prevention",
                            "Self-optimizing node distribution for peak efficiency",
                            "Secure multi-party computation support",
                            "Blockchain-secured data provenance"
                        ],
                        subnodes: [
                            { name: "QSync", icon: "fas fa-sync-alt", description: "Ensures real-time, fault-tolerant quantum data synchronization across distributed nodes.",
                                details: {
                                    "Quantum Mechanism": "Entanglement-assisted clock synchronization",
                                    "Latency Profile": "< 10 ns (intra-zone)",
                                    "Security Rating": "FAA-SEC A+",
                                    "Throughput": "1.2 Pbps"
                                }
                            },
                            { name: "VaultWave", icon: "fas fa-shield-alt", description: "Provides quantum-resistant encryption and secure data vaulting for critical quantum assets.",
                                details: {
                                    "Quantum Mechanism": "Post-quantum cryptographic primitives",
                                    "Encryption Standard": "Qubit-AES256",
                                    "Audit Compliance": "ISO/IEC 27001 Quantum Annex"
                                }
                            },
                            { name: "QubitCast", icon: "fas fa-broadcast-tower", description: "Facilitates secure, high-fidelity distribution of quantum states for advanced applications.",
                                details: {
                                    "Quantum Mechanism": "Quantum key distribution (QKD) - BB84 protocol",
                                    "Error Rate": "< 0.01%",
                                    "Range": "1000 km (fiber optic)"
                                }
                            },
                            { name: "ClaimGrid", icon: "fas fa-scroll", description: "Manages immutable, auditable quantum asset claims and intellectual property rights on a decentralized ledger.",
                                details: {
                                    "Blockchain Protocol": "Quantum-Proof Ledger (QPL)",
                                    "Transaction Speed": "50,000 TPS",
                                    "Legal Compliance": "Global Treaty Grid compatible"
                                }
                            }
                        ]
                    },
                    {
                        name: "PulseQâ„¢â„¢",
                        icon: "fas fa-wave-square", // Wave icon
                        description: "Optimizes quantum pulse generation and detection for high-fidelity quantum operations and communication.",
                        features: [
                            "Adaptive pulse shaping for noise reduction",
                            "High-speed pulse train generation",
                            "Precision qubit manipulation",
                            "Real-time pulse diagnostics",
                            "Integrated with quantum sensing arrays"
                        ],
                        subnodes: [
                            { name: "PulseFlow", icon: "fas fa-stream", description: "Manages the seamless flow of quantum pulses for efficient computation cycles.",
                                details: {
                                    "Pulse Fidelity": "99.999%",
                                    "Coherence Time Support": "Microsecond to millisecond",
                                    "Energy Efficiency": "Low mJ/operation"
                                }
                            },
                            { name: "EntangleLink", icon: "fas fa-link", description: "Establishes and maintains stable quantum entanglement links between distant qubits.",
                                details: {
                                    "Entanglement Rate": "1000 pairs/sec",
                                    "Bell State Purity": "> 98%",
                                    "Connection Stability": "24/7 Uptime"
                                }
                            }
                        ]
                    },
                    {
                        name: "EntanglePathâ„¢â„¢",
                        icon: "fas fa-bezier-curve", // Curve icon, suggesting paths
                        description: "Navigates and optimizes quantum entanglement paths across complex quantum networks for secure communication.",
                        features: [
                            "Dynamic path routing for entangled pairs",
                            "Interference mitigation",
                            "Quantum repeater integration",
                            "Network topology mapping (real-time)",
                            "Secure communication over noisy channels"
                        ],
                        subnodes: [
                            { name: "PathWeave", icon: "fas fa-route", description: "Dynamically weaves the most efficient and secure entanglement paths through multi-node quantum networks.",
                                details: {
                                    "Path Optimization Algorithm": "Quantum Dijkstra-Bellman",
                                    "Node Count Support": "> 1000 nodes",
                                    "Failure Tolerance": "Self-healing network paths"
                                }
                            },
                            { name: "NexusNode", icon: "fas fa-project-diagram", description: "A central nexus point for managing and brokering entanglement connections between disparate quantum systems.",
                                details: {
                                    "Cross-platform Compatibility": "IBM Q, Google Sycamore, etc.",
                                    "Connection Capacity": "10,000 concurrent links",
                                    "Protocol Arbitration": "Automated standard negotiation"
                                }
                            }
                        ]
                    },
                     { name: "QubitNestâ„¢â„¢", icon: "fas fa-cube", description: "Manages and optimizes clusters of qubits for high-performance quantum computing tasks.", features: ["Scalable qubit orchestration", "Error mitigation and correction", "Thermal management for superconductive qubits", "Integrated control systems"], subnodes: [{name: "HyperQubit", icon: "fas fa-microchip", description: "A high-fidelity logical qubit for complex quantum algorithms.", details: {"Coherence Time": "100 Âµs", "Gate Fidelity": "99.99%", "Error Rate": "0.0001%"}}]},
                     { name: "LogicSpinâ„¢â„¢", icon: "fas fa-splotch", description: "Provides advanced quantum logic gate operations and circuit synthesis for complex algorithms.", features: ["Universal gate set support", "Automated circuit optimization", "Fault-tolerant logic operations", "Real-time gate calibration"], subnodes: [{name: "CircuitCraft", icon: "fas fa-code-branch", description: "Tool for designing and testing quantum circuits with intuitive drag-and-drop interface.", details: {"Supported Gates": "H, X, Y, Z, CNOT, Toffoli", "Simulation Speed": "1000 qubits/sec", "Visualizer": "3D Circuit Renderer"}}]},
                     { name: "VaultQuantumâ„¢â„¢", icon: "fas fa-lock", description: "A secure, quantum-proof data storage solution for sensitive information.", features: ["Quantum-resistant encryption", "Decentralized storage nodes", "Immutable data ledger", "Advanced access control"], subnodes: [{name: "SecureQ", icon: "fas fa-fingerprint", description: "Ensures only authorized quantum systems can access encrypted data.", details: {"Authentication Method": "Quantum-key handshake", "Access Latency": "< 5ms", "Integrity Check": "Real-time quantum checksum"}}]},
                     { name: "WaveSignalâ„¢â„¢", icon: "fas fa-signal", description: "Transmits and receives quantum signals with ultra-low noise and high bandwidth.", features: ["Single-photon detection", "Quantum state amplification", "Noise filtering (quantum-aware)", "Adaptive signal processing"], subnodes: [{name: "PhotonRelay", icon: "fas fa-lightbulb", description: "Relays single photons across long distances without loss of quantum information.", details: {"Loss Rate": "< 0.001 dB/km", "Max Distance": "1500 km", "Wavelength": "1550 nm"}}]},
                     { name: "PhaseClaimâ„¢â„¢", icon: "fas fa-certificate", description: "Provides immutable digital certificates for quantum data authenticity and intellectual property.", features: ["Quantum-secured timestamps", "Decentralized issuance", "Automated verification", "Fraud-proof claims"], subnodes: [{name: "AuthQ", icon: "fas fa-stamp", description: "Generates and verifies unique quantum authenticity tokens for digital assets.", details: {"Token Size": "256-qubit", "Verification Time": "< 1ms", "Revocation Mechanism": "Instant"}}]},
                     { name: "GridStateâ„¢â„¢", icon: "fas fa-th", description: "Monitors and visualizes the global quantum network's real-time state and resource allocation.", features: ["Live topology mapping", "Resource utilization tracking", "Anomaly detection in network state", "Predictive congestion alerts"], subnodes: [{name: "NetVisor", icon: "fas fa-map-marked-alt", description: "Offers a comprehensive visualization of the quantum network's health and data flow.", details: {"Display Modes": "2D, 3D Interactive", "Update Frequency": "Sub-second", "Alert Integration": "SMS, Email, API"}}]},
                     { name: "QuantumDropâ„¢â„¢", icon: "fas fa-parachute-box", description: "Enables secure and traceable delivery of quantum data packets across the network.", features: ["Encrypted quantum packet delivery", "Guaranteed delivery protocols", "Real-time tracking of data drops", "Interoperable with classical networks"], subnodes: [{name: "PacketQ", icon: "fas fa-box-open", description: "Manages the routing and delivery of individual quantum data packets.", details: {"Packet Size": "Variable (up to 1 GB)", "Error Correction": "Built-in QEC", "Delivery Assurance": "99.999%"}}]},
                     { name: "SyncQâ„¢â„¢", icon: "fas fa-clock", description: "Synchronizes quantum clocks across distributed quantum systems with atomic precision.", features: ["Global quantum clock synchronization", "Drift compensation algorithms", "High-precision timing for experiments", "Secure time distribution"], subnodes: [{name: "TimeWave", icon: "fas fa-hourglass-start", description: "Distributes a synchronized quantum time signal to all connected nodes.", details: {"Accuracy": "Femtosecond level", "Jitter": "< 1 ps", "Resilience": "Fault-tolerant"}}]},
                     { name: "PulseFieldâ„¢â„¢", icon: "fas fa-compass", description: "Generates and controls electromagnetic fields for manipulating and isolating qubits.", features: ["Programmable field generators", "Precise qubit addressing", "Noise shielding technologies", "Scalable field control for large qubit arrays"], subnodes: [{name: "FieldGen", icon: "fas fa-magnet", description: "Creates custom electromagnetic fields tailored for specific qubit interactions.", details: {"Field Strength": "Up to 10 Tesla", "Frequency Range": "GHz to THz", "Spatial Resolution": "Nanometer scale"}}]},
                     { name: "QLogicâ„¢â„¢", icon: "fas fa-brain", description: "Implements high-level quantum algorithms and logical operations on quantum hardware.", features: ["Algorithm compiler for quantum processors", "Optimal circuit decomposition", "Post-processing of quantum measurement results", "Support for various quantum programming languages"], subnodes: [{name: "AlgoWeaver", icon: "fas fa-magic", description: "Translates high-level quantum algorithms into optimized, executable quantum circuits.", details: {"Supported Algorithms": "Shor's, Grover's, QAOA", "Optimization Metric": "Gate count, depth", "Output Format": "QASM, OpenQASM"}}]},
                     { name: "EntangleProofâ„¢â„¢", icon: "fas fa-fingerprint", description: "Verifies the authenticity and integrity of quantum entanglement in real-time.", features: ["Non-local correlation testing", "Bell inequality violation checks", "Real-time security auditing for QKD", "Tamper detection for entangled states"], subnodes: [{name: "VerifyQ", icon: "fas fa-clipboard-check", description: "Performs instant verification of entanglement properties in quantum communication links.", details: {"Test Frequency": "Continuous", "Pass/Fail Threshold": "Configurable", "Alerts": "Instant notification on anomaly"}}]},
                     { name: "SuperposVaultâ„¢â„¢", icon: "fas fa-archive", description: "Securely stores and manages quantum states in superposition for later retrieval and computation.", features: ["Long-term qubit coherence preservation", "Quantum state encryption", "Non-demolition measurement protocols", "Secure access control for superposition states"], subnodes: [{name: "StatePreserve", icon: "fas fa-cube", description: "Maintains the delicate quantum superposition of qubits during storage.", details: {"Preservation Time": "Days to weeks", "Fidelity Degradation": "< 0.1% / hour", "Environment Control": "Cryogenic, Vacuum"}}]},
                     { name: "ClaimLoopQâ„¢â„¢", icon: "fas fa-redo-alt", description: "Automates the lifecycle of quantum asset claims, from creation to verification and renewal.", features: ["Automated claim generation (on-event)", "Scheduled verification cycles", "Smart contract integration for rights management", "Audit trail for all claim events"], subnodes: [{name: "AutoClaim", icon: "fas fa-robot", description: "An AI-powered agent for automated creation and management of quantum asset claims.", details: {"Trigger Events": "Protocol deployment, data transfer", "Verification Sources": "VaultTrace, QPL", "Renewal Policy": "Customizable"}}]},
                     { name: "QuantumTraceâ„¢â„¢", icon: "fas fa-search-dollar", description: "Provides immutable, auditable trails for all quantum operations and data flows.", features: ["Decentralized ledger for operations", "Forensic analysis of quantum incidents", "Compliance reporting (quantum-specific)", "Tamper-proof record keeping"], subnodes: [{name: "AuditQ", icon: "fas fa-clipboard-list", description: "Generates comprehensive audit reports for quantum operations and data integrity.", details: {"Report Frequency": "Daily, Weekly, On-demand", "Data Points": "50+ metrics", "Export Formats": "PDF, CSV, QJSON"}}]},
                     { name: "QubitEchoâ„¢â„¢", icon: "fas fa-reply", description: "Replicates and distributes quantum states across multiple nodes for redundancy and fault tolerance.", features: ["Quantum state replication protocols", "Decoherence mitigation through echoing", "Fault-tolerant data distribution", "Resilient quantum memory solutions"], subnodes: [{name: "EchoNet", icon: "fas fa-clone", description: "Manages the creation and distribution of quantum state 'echoes' for redundancy.", details: {"Replication Factor": "N-way", "Recovery Time": "Sub-second", "Network Overhead": "Minimal"}}]},
                     { name: "ZeroNodeâ„¢â„¢", icon: "fas fa-minus-circle", description: "A minimalist, hyper-efficient quantum node designed for specialized, low-overhead operations.", features: ["Extremely low power consumption", "Minimalist hardware footprint", "Optimized for single-purpose quantum tasks", "Edge computing capable"], subnodes: [{name: "MiniQubit", icon: "fas fa-microchip", description: "A compact, highly optimized qubit module for specialized quantum operations.", details: {"Size": "Credit card-sized", "Power Draw": "< 10W", "Operating Temperature": "Ambient or Cryo"}}]},
                     { name: "PhaseGridâ„¢â„¢", icon: "fas fa-border-all", description: "Provides a structured framework for managing quantum phases in multi-qubit systems and quantum algorithms.", features: ["Phase error detection and correction", "Quantum gate phase synchronization", "Geometric phase control", "Scalable phase management for large algorithms"], subnodes: [{name: "PhaseSync", icon: "fas fa-sliders-h", description: "Ensures precise synchronization of quantum phases across all qubits during computation.", details: {"Synchronization Accuracy": "0.1 radians", "Drift Compensation": "Dynamic", "Real-time Monitoring": "Enabled"}}]},
                ],
                types: [ // For New Protocol form
                    'Quantum Cryptography', 'Quantum Simulation', 'Quantum Sensing', 'Quantum Networking',
                    'Qubit Teleportation', 'Entanglement Distribution', 'Quantum Error Correction',
                    'Quantum AI', 'Quantum Optimization', 'Quantum Computing Fundamentals'
                ]
            },
            deployments: [], // Will be populated from Firestore (renamed from 'projects')
            deploymentLoadIndex: 0,
            deploymentsPerLoad: 12,
            licenses: [], // Populated from Firestore
            analytics: { // Quantum-specific analytics data
                protocolDeploymentTrends: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Protocol Deployments',
                        data: [10, 15, 12, 18, 20, 25],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                quantumResourceAllocation: {
                    labels: ['Qubit Allocation', 'Network Bandwidth', 'Compute Cycles', 'Storage'],
                    datasets: [{
                        data: [40, 25, 20, 15],
                        backgroundColor: ['#ff8c00', '#0071e3', '#30d158', '#f59e0b'],
                        hoverOffset: 4
                    }]
                },
                qubitActivity: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Qubits (Average)',
                        data: [80, 95, 90, 105, 110, 60, 45],
                        borderColor: 'rgba(48, 209, 88, 0.8)',
                        backgroundColor: 'rgba(48, 209, 88, 0.1)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Entanglement Operations (Thousands)',
                        data: [25, 30, 28, 35, 38, 15, 10],
                        borderColor: 'rgba(255, 140, 0, 0.8)', /* Orange */
                        backgroundColor: 'rgba(255, 140, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                }
            },
            apiKeys: [], // Populated from Firestore
            royaltyAgreements: [], // Populated from Firestore
            colors: { // Dynamic colors based on theme
                primary: null, secondary: null, textDark: null, borderColorDark: null, accentGold: null
            },
            dnsRecords: [], // Populated from Firestore
            quantumNodes: [], // Renamed from 'domains', populated from Firestore
            quantumChannels: [], // Renamed from 'emailAccounts', populated from Firestore
            ecosystemRoadmap: { // NEW: Quantum Ecosystem Roadmap Data
                phases: [
                    {
                        name: "Phase 1: Foundational Quantum Infrastructure",
                        icon: "fas fa-cubes",
                        description: "Establishment of core quantum computing hardware, secure quantum communication links, and foundational software layers.",
                        milestones: [
                            { name: "Global Qubit Network Mesh (GQNM) Alpha Deployment", status: "Completed", date: "2024-12-31", details: [
                                "Deployment of 10 entangled quantum nodes across key regions.",
                                "Initial inter-node communication protocols verified.",
                                "Successful demonstration of secure quantum key distribution."
                            ]},
                            { name: "VaultQuantumâ„¢ v1.0 Launch", status: "Completed", date: "2025-03-15", details: [
                                "Quantum-resistant data vaulting solution released.",
                                "First client data migrated to VaultQuantum.",
                                "Independent security audit passed."
                            ]},
                            { name: "QubitNestâ„¢ Core API Release", status: "In Progress", date: "2025-09-30", details: [
                                "Developer access to distributed qubit clusters.",
                                "Documentation for QubitNestâ„¢ API endpoints.",
                                "Integration with open-source quantum frameworks."
                            ]}
                        ]
                    },
                    {
                        name: "Phase 2: Quantum Protocol Expansion & Standardization",
                        icon: "fas fa-scroll",
                        description: "Development and standardization of advanced quantum protocols for diverse applications, ensuring interoperability and scalability.",
                        milestones: [
                            { name: "EntanglePathâ„¢ v2.0 Release (Dynamic Routing)", status: "Planned", date: "2026-06-30", details: [
                                "Implementation of adaptive quantum routing algorithms.",
                                "Real-time network optimization for entangled pairs.",
                                "Beta testing with early adopter partners."
                            ]},
                            { name: "PhaseClaimâ„¢ Global Compliance Certification", status: "Planned", date: "2026-12-31", details: [
                                "Attainment of global regulatory compliance for quantum asset claims.",
                                "Integration with international legal frameworks.",
                                "Blockchain-secured provenance for quantum IP."
                            ]},
                            { name: "QubitEchoâ„¢ Fault-Tolerant Network Integration", status: "Planned", date: "2027-03-31", details: [
                                "Demonstration of self-healing quantum network segments.",
                                "Protocol for quantum state replication and recovery.",
                                "Increased network resilience against decoherence."
                            ]}
                        ]
                    },
                    {
                        name: "Phase 3: AI-Quantum Symbiosis & Autonomous Operations",
                        icon: "fas fa-brain",
                        description: "Integration of AI for autonomous quantum network management, predictive analytics, and self-optimizing protocol deployment.",
                        milestones: [
                            { name: "AI-Driven Protocol Optimization (LogicSpinâ„¢ Integration)", status: "Future", date: "2027-12-31", details: [
                                "AI models for real-time quantum circuit optimization.",
                                "Automated anomaly detection in quantum operations.",
                                "Predictive maintenance for quantum hardware."
                            ]},
                            { name: "Autonomous Quantum Resource Allocation", status: "Future", date: "2028-06-30", details: [
                                "Self-adjusting qubit allocation based on demand.",
                                "Dynamic re-configuration of quantum network resources.",
                                "Energy efficiency optimization across the quantum grid."
                            ]}
                        ]
                    }
                ]
            }
        };

        const sectorList = { // Static list of sectors for display
            "agriculture": { name: "ðŸŒ± Agriculture & Biotech" },
            "fsf": { name: "ðŸ¥¦ Food, Soil & Farming" },
            "banking": { name: "ðŸ¦ Banking & Finance" },
            "creative": { name: "ðŸ–‹ï¸ Creative Tech" },
            "logistics": { name: "ðŸ“¦ Logistics & Packaging" },
            "education-ip": { name: "ðŸ“š Education & IP" },
            "fashion": { name: "âœ‚ Fashion & Identity" },
            "gaming": { name: "ðŸŽ® Gaming & Simulation" },
            "health": { name: "ðŸ§  Health & Hygiene" },
            "housing": { name: "ðŸ—ï¸ Housing & Infrastructure" },
            "justice": { name: "âš– Justice & Ethics" },
            "knowledge": { name: "ðŸ“– Knowledge & Archives" },
            "micromesh": { name: "â˜° Micro-Mesh Logistics" },
            "media": { name: "ðŸŽ¬ Motion, Media & Sonic" },
            "nutrition": { name: "âœ¿ Nutrition & Food Chain" },
            "ai-logic": { name: "ðŸ§  AI, Logic & Grid" },
            "packaging": { name: "ðŸ“¦ Packaging & Materials" },
            "quantum": { name: "âœ´ï¸ Quantum Protocols", // This is the target sector
                repoName: "quantum-protocols-repo",
                baseUrl: "https://quantum.faa.zone",
                brands: [
                    { name: "QuantumMeshâ„¢â„¢", subnodes: ["QSync", "VaultWave", "QubitCast", "ClaimGrid"] },
                    { name: "PulseQâ„¢â„¢", subnodes: ["PulseFlow", "EntangleLink"] },
                    { name: "EntanglePathâ„¢â„¢", subnodes: ["PathWeave", "NexusNode"] }
                    // Add more quantum-specific brands/subnodes as needed
                ]
            },
            "ritual": { name: "â˜¯ Ritual & Culture" },
            "saas": { name: "ðŸ”‘ SaaS & Licensing" },
            "trade": { name: "ðŸ§º Trade Systems" },
            "utilities": { name: "ðŸ”‹ Utilities & Energy" },
            "voice": { name: "ðŸŽ™ï¸ Voice & Audio" },
            "webless": { name: "ðŸ“¡ Webless Tech & Nodes" },
            "nft": { name: "ðŸ” NFT & Ownership" },
            "education-youth": { name: "ðŸŽ“ Education & Youth" },
            "zerowaste": { name: "â™»ï¸ Zero Waste" },
            "professional": { name: "ðŸ§¾ Professional Services" },
            "payroll-mining": { name: "ðŸª™ Payroll Mining & Accounting" },
            "mining": { name: "â›ï¸ Mining & Resources" },
            "wildlife": { name: "ðŸ¦ Wildlife & Habitat" },
            "admin-panel": { name: "âš™ï¸ Admin Panel" }
        };

        // This will be loaded from Firestore
        let allSectorsData = {};
        let companyData = {};


        // --- Utility Functions ---

        // Global functions must be attached to window to be called by inline onclicks
        window.showCustomModal = function(title, message, autoDismiss = true) {
            const modal = document.getElementById('customModal');
            const modalMessage = modal.querySelector('p');
            if (modal && modalMessage) {
                modalMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
                modal.classList.remove('hidden');
                if (autoDismiss) {
                    setTimeout(() => {
                        window.hideCustomModal();
                    }, 3000);
                }
            }
        };

        window.hideCustomModal = function() {
            document.getElementById('customModal')?.classList.add('hidden');
        };

        // --- Checkout Flow Functions (adapted for Quantum) ---
        window.showCheckoutStep = function(step) {
            // Hide all checkout steps
            document.querySelectorAll('[id^="checkout-step-"]').forEach(el => {
                el.classList.add('hidden');
            });
            // Show the requested step
            document.getElementById(`checkout-step-${step}`)?.classList.remove('hidden');
            // Reset payment status message
            document.getElementById('paymentStatus')?.classList.add('hidden');
            document.getElementById('orderStatus')?.classList.add('hidden');
        };

        window.processPayment = function() {
            const paymentStatus = document.getElementById('paymentStatus');
            const orderStatus = document.getElementById('orderStatus');
            paymentStatus.textContent = "Processing payment...";
            paymentStatus.classList.remove('hidden');
            
            // Simulate payment processing
            setTimeout(() => {
                paymentStatus.textContent = "Payment successful! Initiating VaultClaimâ„¢ license...";
                paymentStatus.classList.add('text-green-400');
                paymentStatus.classList.remove('text-red-400'); // Ensure it's green
                window.showCheckoutStep(3); // Move to confirmation step
                orderStatus.textContent = "Status: VaultClaimâ„¢ License Activated!";
                orderStatus.classList.remove('hidden');
            }, 2000);
        };

        window.resetCheckout = function() {
            window.showCheckoutStep(1); // Reset to first step
            document.getElementById('cardNumber').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('cvc').value = '';
            document.getElementById('paymentStatus').classList.add('hidden');
            document.getElementById('orderStatus').classList.add('hidden');
            document.getElementById('paymentStatus').classList.remove('text-green-400');
            document.getElementById('paymentStatus').classList.add('text-red-400'); // Reset to red for future errors
            showView('dashboard'); // Optionally go back to dashboard
        };


        // --- View Management (Client-side Router) ---
        let currentChartInstances = {}; // To store Chart.js instances for destruction

        function showView(viewId) {
            // Update URL hash
            window.location.hash = viewId;

            // Hide all views
            document.querySelectorAll('.main-content .view').forEach(view => {
                view.classList.add('view-hidden');
            });
            // Show the requested view
            document.getElementById(`${viewId}-view`)?.classList.remove('view-hidden');

            // Update active state in sidebar nav
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                if (link.getAttribute('data-view') === viewId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Handle view-specific rendering
            renderViewContent(viewId);
        }

        function renderViewContent(viewId) {
            // Destroy existing charts to prevent canvas errors on view change
            for (const chartId in currentChartInstances) {
                if (currentChartInstances[chartId]) {
                    currentChartInstances[chartId].destroy();
                    currentChartInstances[chartId] = null;
                }
            }

            // Only render content if Firebase is ready (userId is set)
            if (window.getUserId() === 'loading' && viewId !== 'login' && viewId !== 'signup') {
                console.log("Firebase not ready, deferring rendering for view:", viewId);
                // Optionally show a loading message or spinner
                return;
            }

            if (viewId === 'dashboard') {
                updateDashboardMetrics(); // This will fetch from Firestore
                renderDashboardCharts();
            } else if (viewId === 'deployments') {
                FAA_QUANTUM_DATA.deploymentLoadIndex = 0; // Reset load index when entering deployments view
                renderDeployments(); // This will fetch from Firestore
            } else if (viewId === 'protocols') {
                renderProtocols(); // This displays static quantum brands
            } else if (viewId === 'pricing') {
                window.showCheckoutStep(1); // Start checkout at step 1
                updatePrices(document.getElementById('currency-select').value); // Update prices on view load
            }
            else if (viewId === 'quantum-insights') {
                renderQuantumInsightsCharts();
            } else if (viewId === 'ecosystem-roadmap') {
                renderEcosystemRoadmap(); // Render the new roadmap
            }
            else if (viewId === 'api-keys') {
                renderApiKeysTable(); // This will fetch from Firestore
            } else if (viewId === 'settings') {
                loadSettings(); // This will fetch from Firestore
                showSettingsTab('profile'); // Default to profile tab when entering settings
            } else if (viewId === 'login' || viewId === 'signup') {
                // Clear forms on view change
                document.getElementById('loginForm')?.reset();
                document.getElementById('signupForm')?.reset();
            }
        }

        // Centralized function to render all Firestore-backed data when authenticated
        async function renderAllFirestoreData() {
            // Fetch public data first
            const publicDataPath = `artifacts/${APP_ID}/public/data`;
            const companiesRef = await window.firestoreGetCollection(`${publicDataPath}/companies`);
            companyData = companiesRef.reduce((acc, company) => {
                acc[company.id] = company;
                return acc;
            }, {});
            console.log("Loaded public company data:", companyData);

            const allSectorsRef = await window.firestoreGetCollection(`${publicDataPath}/sectors`);
            allSectorsData = allSectorsRef.reduce((acc, sector) => {
                acc[sector.id] = sector;
                return acc;
            }, {});
            console.log("Loaded public sector data:", allSectorsData);

            // Set up real-time listeners for dashboard metrics
            const dashboardDocPath = `artifacts/${APP_ID}/dashboardMetrics`;
            window.firestoreOnDocumentSnapshot(dashboardDocPath, 'quantum-metrics', (data) => {
                if (data) {
                    document.getElementById('activeConnectionsCount').textContent = (data.activeConnections || 0).toLocaleString();
                    document.getElementById('quantumOperationsCount').textContent = (data.quantumOperations || 0).toLocaleString();
                    document.getElementById('protocolEfficiencyPercentage').textContent = `${(data.protocolEfficiency || 0).toFixed(1)}%`;
                } else {
                    // If document doesn't exist, initialize it
                    window.firestoreSetDoc(dashboardDocPath, 'quantum-metrics', {
                        activeConnections: 1234,
                        quantumOperations: 5678901,
                        protocolEfficiency: 98.7
                    });
                }
            });

            // Set up real-time listener for user deployments (renamed from projects)
            const userDeploymentsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/deployments`;
            window.firestoreOnCollectionSnapshot(userDeploymentsPath, (deployments) => {
                FAA_QUANTUM_DATA.deployments = deployments.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity)); // Sort by most recent
                renderDeployments(); // Re-render deployments view when data changes
            });

            // Set up real-time listener for user licenses
            const userLicensesPath = `artifacts/${APP_ID}/users/${window.getUserId()}/licenses`;
            window.firestoreOnCollectionSnapshot(userLicensesPath, (licenses) => {
                FAA_QUANTUM_DATA.licenses = licenses;
                // No direct rendering for licenses in this dashboard, but keeping for future expansion
            });

            // Set up real-time listener for user royalty agreements
            const userRoyaltyAgreementsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/royaltyAgreements`;
            window.firestoreOnCollectionSnapshot(userRoyaltyAgreementsPath, (agreements) => {
                FAA_QUANTUM_DATA.royaltyAgreements = agreements;
                // No direct rendering for royalty agreements in this dashboard, but keeping for future expansion
            });

            // Set up real-time listener for API keys (consider them private to user for now)
            const userApiKeysPath = `artifacts/${APP_ID}/users/${window.getUserId()}/apiKeys`;
            window.firestoreOnCollectionSnapshot(userApiKeysPath, (apiKeys) => {
                FAA_QUANTUM_DATA.apiKeys = apiKeys;
                if (document.getElementById('api-keys-view')?.classList.contains('view-hidden') === false) {
                    renderApiKeysTable(); // Re-render API keys table if currently active
                }
            });

            // Set up real-time listener for DNS records
            const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
            window.firestoreOnCollectionSnapshot(publicDnsRecordsPath, (records) => {
                FAA_QUANTUM_DATA.dnsRecords = records;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderDnsRecords();
                }
            });

            // Set up real-time listener for quantum nodes (renamed from domains)
            const publicQuantumNodesPath = `artifacts/${APP_ID}/public/data/quantumNodes`;
            window.firestoreOnCollectionSnapshot(publicQuantumNodesPath, (nodes) => {
                FAA_QUANTUM_DATA.quantumNodes = nodes;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderQuantumNodes();
                }
            });

            // Set up real-time listener for quantum channels (renamed from emailAccounts)
            const publicQuantumChannelsPath = `artifacts/${APP_ID}/public/data/quantumChannels`;
            window.firestoreOnCollectionSnapshot(publicQuantumChannelsPath, (channels) => {
                FAA_QUANTUM_DATA.quantumChannels = channels;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderQuantumChannels();
                }
            });
            // Re-render the current view after Firebase data is loaded
            renderViewContent(window.location.hash.substring(1) || 'dashboard');
        }

        // --- Dashboard Specific Logic ---
        function updateDashboardMetrics() {
            // Metrics are now updated by the onSnapshot listener in renderAllFirestoreData
        }

        function renderDashboardCharts() {
            // Security Incident Trend Chart
            const secIncCtx = document.getElementById('securityIncidentsChart')?.getContext('2d');
            if (secIncCtx) {
                currentChartInstances.securityIncidentsChart = new Chart(secIncCtx, {
                    type: 'bar',
                    data: FAA_QUANTUM_DATA.dashboard.securityIncidents,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Hide legend as there's only one dataset
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }

            // Protocol Performance Chart
            const protPerfCtx = document.getElementById('protocolPerformanceChart')?.getContext('2d');
            if (protPerfCtx) {
                currentChartInstances.protocolPerformanceChart = new Chart(protPerfCtx, {
                    type: 'line',
                    data: FAA_QUANTUM_DATA.dashboard.protocolPerformance,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white',
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // --- Protocols View Logic (Enhanced with containers, icons, and expand/collapse) ---
        function renderProtocols() {
            const protocolBrandsContainer = document.getElementById('protocolBrandsContainer');
            if (!protocolBrandsContainer) return;
            protocolBrandsContainer.innerHTML = ''; // Clear existing content

            if (FAA_QUANTUM_DATA.protocols.coreBrands.length === 0) {
                protocolBrandsContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No quantum protocol brands found.</p>';
            }

            FAA_QUANTUM_DATA.protocols.coreBrands.forEach(brand => {
                const brandCard = document.createElement('div');
                brandCard.className = 'bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 transition-all duration-300 hover:scale-[1.02]';
                brandCard.innerHTML = `
                    <button class="toggle-protocol-section-btn flex items-center justify-between w-full text-left cursor-pointer p-2 -m-2 rounded-md hover:bg-gray-700 transition-colors duration-200" onclick="window.toggleProtocolSection('brand-details-${brand.name.replace(/â„¢/g, '').replace(/ /g, '-').toLowerCase()}')">
                        <h4 class="text-2xl font-bold text-orange-400 flex items-center">
                            <i class="${brand.icon} mr-3 text-3xl"></i> ${brand.name}
                        </h4>
                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                    </button>
                    <div id="brand-details-${brand.name.replace(/â„¢/g, '').replace(/ /g, '-').toLowerCase()}" class="protocol-section-content hidden mt-4">
                        <p class="text-gray-300 mb-4 text-sm">${brand.description}</p>
                        <h5 class="text-lg font-semibold text-white mb-2">Key Features:</h5>
                        <ul class="list-disc list-inside text-gray-400 text-sm mb-4">
                            ${brand.features.map(feature => `<li>${feature}</li>`).join('')}
                        </ul>
                        <h5 class="text-lg font-semibold text-white mb-2">Subnodes:</h5>
                        <div class="space-y-3">
                            ${brand.subnodes.map(subnode => `
                                <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                                    <button class="toggle-protocol-section-btn flex items-center justify-between w-full text-left cursor-pointer p-1 -m-1 rounded-md hover:bg-gray-600 transition-colors duration-200" onclick="window.toggleProtocolSection('subnode-details-${subnode.name.replace(/ /g, '-').toLowerCase()}')">
                                        <h6 class="text-lg font-semibold text-blue-400 flex items-center">
                                            <i class="${subnode.icon} mr-2 text-xl"></i> ${subnode.name}
                                        </h6>
                                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                                    </button>
                                    <div id="subnode-details-${subnode.name.replace(/ /g, '-').toLowerCase()}" class="protocol-section-content hidden mt-2">
                                        <p class="text-gray-300 text-sm mb-3">${subnode.description}</p>
                                        <h6 class="font-semibold text-white mb-1 text-sm">Technical Details:</h6>
                                        <ul class="list-disc list-inside text-gray-400 text-xs mb-3">
                                            ${Object.entries(subnode.details).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join('')}
                                        </ul>
                                        <button class="form-action-button text-xs px-3 py-2" onclick="window.showCustomModal('Use Protocol', 'Initiating connection to ${subnode.name}. This would typically open a new interface or API documentation. (Simulation)')">
                                            <i class="fas fa-play mr-1"></i> Use Protocol
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                protocolBrandsContainer.appendChild(brandCard);
            });
        }

        // Generic toggle function for protocol sections
        window.toggleProtocolSection = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
                const icon = element.previousElementSibling.querySelector('i.fa-chevron-down, i.fa-chevron-up');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            }
        };

        // --- Deployments View Logic (Adapted from Projects) ---
        function renderDeployments(append = false) {
            const deploymentsListContainer = document.getElementById('deploymentsList');
            if (!deploymentsListContainer) return;

            if (!append) {
                deploymentsListContainer.innerHTML = ''; // Clear existing deployments unless appending
                FAA_QUANTUM_DATA.deploymentLoadIndex = 0;
            }

            const searchTerm = document.getElementById('deploymentSearch')?.value.toLowerCase() || '';
            const filterStatus = document.getElementById('deploymentFilterStatus')?.value || 'all';

            // Apply search and filter to all deployments first
            const filteredDeployments = FAA_QUANTUM_DATA.deployments.filter(deployment => {
                const matchesSearch = deployment.name.toLowerCase().includes(searchTerm) || deployment.id.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || deployment.status === filterStatus;
                return matchesSearch && matchesStatus;
            });

            // Determine which deployments to render based on load index
            const deploymentsToRender = filteredDeployments.slice(FAA_QUANTUM_DATA.deploymentLoadIndex, FAA_QUANTUM_DATA.deploymentLoadIndex + FAA_QUANTUM_DATA.deploymentsPerLoad);

            if (deploymentsToRender.length === 0 && FAA_QUANTUM_DATA.deploymentLoadIndex === 0) {
                deploymentsListContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No deployments found. Deploy a new protocol!</p>';
            }

            deploymentsToRender.forEach(deployment => {
                const deploymentCard = document.createElement('div');
                deploymentCard.className = 'project-card'; // Reusing project-card class for styling
                deploymentCard.innerHTML = `
                    <h4 class="mb-2">${deployment.name}</h4>
                    <p><strong>ID:</strong> ${deployment.id}</p>
                    <p><strong>Zone:</strong> ${deployment.deploymentZone}</p>
                    <p><strong>VaultClaim:</strong> ${deployment.vaultClaimEnabled ? 'Enabled' : 'N/A'}</p>
                    <p><strong>Last Activity:</strong> ${new Date(deployment.lastActivity).toLocaleDateString()}</p>
                    <span class="project-status status-${deployment.status}">${deployment.status.toUpperCase()}</span>
                    <div class="project-actions">
                        <button onclick="window.showCustomModal('Action', 'Viewing details for ${deployment.name} (ID: ${deployment.id})...')">
                            <i class="fas fa-search mr-1"></i> Details
                        </button>
                        <button class="secondary" onclick="window.showCustomModal('Action', 'Managing live quantum stream for ${deployment.name} (ID: ${deployment.id})...')">
                            <i class="fas fa-wifi mr-1"></i> Live Stream
                        </button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2" onclick="window.summarizeProtocol('${deployment.id}', this)">
                            <i class="fas fa-file-alt"></i> âœ¨ Summarize Protocol
                        </button>
                        <p id="protocolSummaryStatus-${deployment.id}" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                `;
                deploymentsListContainer.appendChild(deploymentCard);
            });

            FAA_QUANTUM_DATA.deploymentLoadIndex += deploymentsToRender.length;

            const loadMoreButton = document.getElementById('loadMoreDeployments');
            if (loadMoreButton) {
                if (FAA_QUANTUM_DATA.deploymentLoadIndex >= filteredDeployments.length) {
                    loadMoreButton.classList.add('view-hidden'); // Hide if no more deployments
                } else {
                    loadMoreButton.classList.remove('view-hidden');
                }
            }
        }

        // Function to summarize a protocol (NEW FEATURE)
        window.summarizeProtocol = async function(protocolId, buttonElement) {
            const protocol = FAA_QUANTUM_DATA.deployments.find(p => p.id === protocolId);
            if (!protocol) {
                window.showCustomModal('Error', 'Protocol not found for summarization.');
                return;
            }

            const statusElementId = `protocolSummaryStatus-${protocolId}`;
            const statusElement = document.getElementById(statusElementId);

            const prompt = `Summarize the following quantum protocol deployment details concisely (max 80 words):
            Protocol Name: ${protocol.name}
            ID: ${protocol.id}
            Status: ${protocol.status}
            Deployment Zone: ${protocol.deploymentZone}
            VaultClaim Enabled: ${protocol.vaultClaimEnabled ? 'Yes' : 'No'}
            Last Activity: ${new Date(protocol.lastActivity).toLocaleDateString()}

            Highlight the protocol's current state and main purpose.`;
            
            // Using a temporary invisible element for the target, as the output goes to a modal
            const tempOutputDiv = document.createElement('div');
            tempOutputDiv.id = `tempProtocolSummaryOutput-${protocolId}`;
            tempOutputDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(tempOutputDiv);

            const summaryText = await window.callGeminiAPI(prompt, tempOutputDiv.id, statusElementId, buttonElement, 'Summarize Protocol');

            if (summaryText) {
                window.showProtocolSummaryModal(`${protocol.name} Summary`, summaryText);
            } else {
                window.showCustomModal('Summarization Failed', 'Could not generate protocol summary. Please try again.');
            }
            document.body.removeChild(tempOutputDiv); // Clean up the temporary element
        };

        // Event listeners for deployment search/filter
        document.getElementById('deploymentSearch')?.addEventListener('input', () => renderDeployments(false));
        document.getElementById('deploymentFilterStatus')?.addEventListener('change', () => renderDeployments(false));
        document.getElementById('loadMoreDeployments')?.addEventListener('click', () => renderDeployments(true));


        // --- Gemini API Call Function ---
        window.callGeminiAPI = async function(prompt, targetElementId, statusElementId, buttonElement, type, parseJson = false) {
            const targetElement = document.getElementById(targetElementId);
            const statusElement = document.getElementById(statusElementId);
            
            if (!targetElement || !statusElement || !buttonElement) {
                console.error("Missing target, status element, or button element for Gemini API call.");
                return null; // Return null on error
            }

            statusElement.textContent = "Generating...";
            statusElement.classList.remove('hidden');
            if (targetElementId !== 'tempSimplifyOutput' && !targetElementId.startsWith('tempProtocolSummaryOutput') && !targetElementId.startsWith('tempAnomalyOutput')) { // Don't hide the temp div used for simplification, project summary, or anomaly
                targetElement.classList.add('hidden'); // Hide output until ready
            }
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="inline-block border-4 border-t-blue-500 border-gray-300 rounded-full w-5 h-5 animate-spin"></span>`; // Show spinner

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    if (parseJson) {
                        try {
                            const jsonResult = JSON.parse(text);
                            statusElement.textContent = "Generation complete!";
                            return jsonResult; // Return the parsed JSON object
                        } catch (jsonError) {
                            console.error("Failed to parse JSON from Gemini API:", jsonError);
                            statusElement.textContent = "Error: Could not parse AI response as JSON.";
                            return null;
                        }
                    } else {
                        // Check if the target is a textarea (has .value) or a general element (use .innerHTML)
                        if (targetElement.tagName === 'TEXTAREA' || targetElement.tagName === 'INPUT') {
                            targetElement.value = text;
                        } else {
                            targetElement.innerHTML = text; // For div or p tags
                        }
                        targetElement.classList.remove('hidden'); // Show output
                        statusElement.textContent = "Generation complete!";
                        return text; // Return the raw text
                    }
                } else {
                    statusElement.textContent = "Error: No content generated by AI.";
                    console.error("Gemini API returned an unexpected structure or no content:", result);
                    return null;
                }
            } catch (error) {
                statusElement.textContent = "Error: API call failed.";
                console.error("Error calling Gemini API:", error);
                return null;
            } finally {
                buttonElement.disabled = false;
                // Restore button text based on 'type' (from parameter)
                let originalButtonText = '';
                if (type === 'AI Generate') {
                    originalButtonText = 'AI Generate';
                } else if (type === 'Summarize Protocol') {
                    originalButtonText = 'Summarize Protocol';
                } else if (type === 'Simplify Agreement') {
                    originalButtonText = 'Simplify Agreement';
                } else if (type === 'Generate Quantum Code') {
                    originalButtonText = 'Generate Quantum Code';
                } else if (type === 'Optimize Quantum Code') {
                    originalButtonText = 'Optimize Quantum Code';
                } else if (type === 'Explain Quantum Code') {
                    originalButtonText = 'Explain Quantum Code';
                } else if (type === 'Investigate Anomaly') {
                    originalButtonText = 'Investigate';
                }
                else if (type === 'Explain DNS Type') {
                    originalButtonText = 'Explain DNS Type';
                } else if (type === 'Draft Channel Message') {
                    originalButtonText = 'Generate Draft';
                }
                else {
                    originalButtonText = 'Action'; // Fallback
                }
                
                buttonElement.innerHTML = `<i class="${buttonElement.querySelector('i')?.className || 'fas fa-magic'} mr-1"></i> âœ¨ ${originalButtonText}`; // Preserve icon
                setTimeout(() => statusElement.classList.add('hidden'), 3000); // Hide status after a few seconds
            }
        };


        // --- New Protocol Form Logic (with Gemini API Integration) ---
        document.getElementById('newProtocolForm')?.addEventListener('submit', async function(event) {
            event.preventDefault();
            const protocolName = document.getElementById('protocolName').value;
            const protocolType = document.getElementById('protocolType').value;
            const protocolDescription = document.getElementById('protocolDescription').value;
            const deploymentZone = document.getElementById('deploymentZone').value;
            const vaultClaim = document.getElementById('vaultClaim').value;

            const newProtocolData = {
                name: protocolName,
                type: protocolType,
                description: protocolDescription,
                deploymentZone: deploymentZone,
                vaultClaimEnabled: vaultClaim === 'yes',
                status: 'draft',
                lastActivity: new Date().toISOString(),
            };

            const userDeploymentsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/deployments`;
            try {
                const newDeploymentId = await window.firestoreAddDoc(userDeploymentsPath, newProtocolData);
                if (newDeploymentId) {
                    window.showCustomModal('Protocol Created!', `Your protocol "${protocolName}" has been created (ID: ${newDeploymentId}). Status: Draft.`, true);
                    // Update dashboard metrics (total deployments)
                    const dashboardDocPath = `artifacts/${APP_ID}/dashboardMetrics`;
                    const metrics = await window.firestoreGetDoc(dashboardDocPath, 'quantum-metrics');
                    if (metrics) {
                        await window.firestoreUpdateDoc(dashboardDocPath, 'quantum-metrics', { totalProtocols: (metrics.totalProtocols || 0) + 1 });
                    } else {
                        await window.firestoreSetDoc(dashboardDocPath, 'quantum-metrics', { totalProtocols: 1, activeConnections: 0, quantumOperations: 0, protocolEfficiency: 0 });
                    }

                    this.reset(); // Clear form
                    showView('deployments'); // Go to deployments view
                } else {
                    window.showCustomModal('Error', 'Failed to create protocol in Firestore.', true);
                }
            } catch (error) {
                window.showCustomModal('Error', `Failed to create protocol: ${error.message}`, true);
            }
        });

        // Event listener for Generate Protocol Description Button
        document.getElementById('generateProtocolDescriptionBtn')?.addEventListener('click', async (event) => {
            const protocolName = document.getElementById('protocolName').value.trim();
            const protocolTypeSelect = document.getElementById('protocolType');
            const protocolType = protocolTypeSelect.options[protocolTypeSelect.selectedIndex]?.textContent || 'Generic Quantum Protocol';
            const deploymentZone = document.getElementById('deploymentZone').value;
            const button = event.currentTarget;

            if (!protocolName) {
                window.showCustomModal('Input Required', 'Please enter a Protocol Name to generate a description.');
                return;
            }

            const prompt = `Generate a concise and engaging description (max 100 words, 3-4 sentences) for a quantum protocol named '${protocolName}' of type '${protocolType}' intended for a '${deploymentZone}' deployment. Focus on its quantum mechanism, benefits, and key features.`;
            await window.callGeminiAPI(prompt, 'protocolDescription', 'protocolDescriptionStatus', button, 'AI Generate');
        });

        // Event listener for Generate Protocol Idea Button
        document.getElementById('generateProtocolIdeaBtn')?.addEventListener('click', async (event) => {
            const quantumConcept = document.getElementById('quantumConcept').value.trim();
            const button = event.currentTarget;
            const statusElement = document.getElementById('protocolIdeaStatus');

            if (!quantumConcept) {
                window.showCustomModal('Input Required', 'Please enter a core quantum concept to generate an idea.');
                return;
            }
            
            statusElement.textContent = "Generating protocol idea...";
            statusElement.classList.remove('hidden');

            const availableTypes = FAA_QUANTUM_DATA.protocols.types.join(', ');
            const prompt = `Generate a creative quantum protocol name (max 5 words), a 3-4 sentence protocol description highlighting its quantum principles and benefits, and suggest one suitable protocol type from the following list: ${availableTypes}. The protocol is based on the concept of: "${quantumConcept}". Respond as a JSON object with keys: "protocolName", "protocolDescription", "suggestedType".`;
            
            const aiIdea = await window.callGeminiAPI(prompt, 'hiddenIdeaOutput', 'protocolIdeaStatus', button, 'AI Generate', true); // Use a hidden output element, parse JSON

            if (aiIdea) {
                window.showProtocolIdeaModal(aiIdea.protocolName, aiIdea.protocolDescription, aiIdea.suggestedType);
            } else {
                statusElement.textContent = "Failed to generate protocol idea. Please try again.";
            }
        });

        // NEW: Quantum Code Development Buttons Logic
        document.getElementById('generateQuantumCodeBtn')?.addEventListener('click', async (event) => {
            const description = document.getElementById('quantumCodeDescription').value.trim();
            const button = event.currentTarget;
            if (!description) {
                window.showCustomModal('Input Required', 'Please describe the quantum code you want to generate.');
                return;
            }
            const prompt = `Generate a concise quantum code snippet (using a standard library like Qiskit or Cirq, indicate which) for the following description: "${description}". Provide ONLY the code block, no explanations or additional text.`;
            await window.callGeminiAPI(prompt, 'quantumCodeArea', 'quantumCodeGenStatus', button, 'Generate Quantum Code');
        });

        document.getElementById('optimizeQuantumCodeBtn')?.addEventListener('click', async (event) => {
            const code = document.getElementById('quantumCodeArea').value.trim();
            const button = event.currentTarget;
            if (!code) {
                window.showCustomModal('Input Required', 'Please paste quantum code into the Quantum Code Area to optimize.');
                return;
            }
            const prompt = `Optimize the following quantum code snippet for efficiency, reduced gate count, or improved coherence, if possible. Provide ONLY the optimized code block, no explanations or additional text. \n\n${code}`;
            await window.callGeminiAPI(prompt, 'quantumCodeArea', 'quantumCodeOptExplainStatus', button, 'Optimize Quantum Code');
        });

        document.getElementById('explainQuantumCodeBtn')?.addEventListener('click', async (event) => {
            const code = document.getElementById('quantumCodeArea').value.trim();
            const button = event.currentTarget;
            if (!code) {
                window.showCustomModal('Input Required', 'Please paste quantum code into the Quantum Code Area to explain.');
                return;
            }
            const prompt = `Explain the following quantum code snippet: \n\n${code}\n\n Describe its purpose, the quantum operations it performs, and any key concepts or principles involved. Focus on clarity for a quantum engineer.`;
            await window.callGeminiAPI(prompt, 'quantumCodeExplanationOutput', 'quantumCodeOptExplainStatus', button, 'Explain Quantum Code');
        });


        // --- Pricing View Logic ---
        // Placeholder exchange rates - In a real application, you would fetch these from a reliable API
        const exchangeRates = {
            "USD": 1.0,
            "EUR": 0.92, // Example rate
            "GBP": 0.79, // Example rate
            "JPY": 159.67, // Example rate
            "CAD": 1.37, // Example rate
            "AUD": 1.50, // Example rate
            "ZAR": 18.25 // Example rate
        };

        const basePricesUSD = {
            starter: 96.00,
            pro: 348.00
        };

        function updatePrices(currency) {
            const rate = exchangeRates[currency] || 1.0; // Default to 1.0 if currency not found

            document.getElementById('starter-price').textContent = (basePricesUSD.starter * rate).toFixed(2);
            document.getElementById('starter-currency').textContent = currency;

            document.getElementById('pro-price').textContent = (basePricesUSD.pro * rate).toFixed(2);
            document.getElementById('pro-currency').textContent = currency;
        }

        document.getElementById('currency-select')?.addEventListener('change', (event) => {
            updatePrices(event.target.value);
        });
        // Initial update to display USD prices
        updatePrices('USD');


        // --- Quantum Insights View Logic (Adapted from Analytics) ---
        function renderQuantumInsightsCharts() {
            // Protocol Deployment Trends
            const pdtCtx = document.getElementById('protocolDeploymentTrendsChart')?.getContext('2d');
            if (pdtCtx) {
                currentChartInstances.protocolDeploymentTrendsChart = new Chart(pdtCtx, {
                    type: 'bar',
                    data: FAA_QUANTUM_DATA.analytics.protocolDeploymentTrends,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }

            // Quantum Resource Allocation
            const qraCtx = document.getElementById('quantumResourceAllocationChart')?.getContext('2d');
            if (qraCtx) {
                currentChartInstances.quantumResourceAllocationChart = new Chart(qraCtx, {
                    type: 'doughnut',
                    data: FAA_QUANTUM_DATA.analytics.quantumResourceAllocation,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white', font: { family: 'Inter' } } } },
                    }
                });
            }

            // Qubit Activity
            const qaCtx = document.getElementById('qubitActivityChart')?.getContext('2d');
            if (qaCtx) {
                currentChartInstances.qubitActivityChart = new Chart(qaCtx, {
                    type: 'line',
                    data: FAA_QUANTUM_DATA.analytics.qubitActivity,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? FAA_QUANTUM_DATA.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }
        }

        // --- Ecosystem Roadmap Logic (NEW) ---
        function renderEcosystemRoadmap() {
            const roadmapContainer = document.getElementById('roadmapContainer')?.querySelector('.space-y-4');
            if (!roadmapContainer) return;
            roadmapContainer.innerHTML = ''; // Clear previous content

            if (FAA_QUANTUM_DATA.ecosystemRoadmap.phases.length === 0) {
                roadmapContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No roadmap data found.</p>';
                return;
            }

            FAA_QUANTUM_DATA.ecosystemRoadmap.phases.forEach(phase => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'bg-gray-700 p-5 rounded-lg shadow-md border border-gray-600';
                phaseDiv.innerHTML = `
                    <button class="toggle-protocol-section-btn flex items-center justify-between w-full text-left cursor-pointer p-2 -m-2 rounded-md hover:bg-gray-600 transition-colors duration-200" onclick="window.toggleProtocolSection('phase-details-${phase.name.replace(/ /g, '-').toLowerCase()}')">
                        <h4 class="text-xl font-bold text-orange-300 flex items-center">
                            <i class="${phase.icon} mr-3 text-2xl"></i> ${phase.name}
                        </h4>
                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                    </button>
                    <div id="phase-details-${phase.name.replace(/ /g, '-').toLowerCase()}" class="protocol-section-content hidden mt-4">
                        <p class="text-gray-300 mb-4 text-sm">${phase.description}</p>
                        <h5 class="text-lg font-semibold text-white mb-3">Key Milestones:</h5>
                        <div class="space-y-3 pl-2">
                            ${phase.milestones.map(milestone => `
                                <div class="bg-gray-800 p-3 rounded-md border border-gray-700">
                                    <button class="toggle-protocol-section-btn flex items-center justify-between w-full text-left cursor-pointer p-1 -m-1 rounded-md hover:bg-gray-700 transition-colors duration-200" onclick="window.toggleProtocolSection('milestone-details-${milestone.name.replace(/ /g, '-').toLowerCase()}')">
                                        <h6 class="text-base font-semibold text-blue-300 flex items-center">
                                            <i class="fas fa-flag-checkered mr-2 text-lg"></i> ${milestone.name}
                                        </h6>
                                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                                    </button>
                                    <div id="milestone-details-${milestone.name.replace(/ /g, '-').toLowerCase()}" class="protocol-section-content hidden mt-2">
                                        <p class="text-gray-400 text-xs mb-1">Status: <span class="font-semibold text-white ${milestone.status === 'Completed' ? 'text-green-500' : milestone.status === 'In Progress' ? 'text-yellow-500' : 'text-gray-500'}">${milestone.status}</span></p>
                                        <p class="text-gray-400 text-xs mb-2">Target Date: <span class="font-semibold text-white">${milestone.date}</span></p>
                                        <ul class="list-disc list-inside text-gray-400 text-xs pl-2">
                                            ${milestone.details.map(detail => `<li>${detail}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                roadmapContainer.appendChild(phaseDiv);
            });
        }

        // --- API Keys View Logic ---
        function renderApiKeysTable() {
            const apiKeysTableBody = document.getElementById('apiKeysTableBody');
            if (!apiKeysTableBody) return;
            apiKeysTableBody.innerHTML = '';

            if (FAA_QUANTUM_DATA.apiKeys.length === 0) {
                apiKeysTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">No API keys found.</td></tr>';
            }

            FAA_QUANTUM_DATA.apiKeys.forEach(keyData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold text-gray-200">${keyData.service} <br> ${keyData.context ? `<span class="text-xs text-gray-400">(${keyData.context})</span>` : ''}</td>
                    <td class="api-key-value">${keyData.key}</td>
                    <td class="text-gray-400 text-sm">${keyData.locations.join(', ')}</td>
                `;
                apiKeysTableBody.appendChild(row);
            });
        }

        // --- Settings View Logic ---
        async function loadSettings() {
            if (window.getUserId() === 'loading') {
                console.log("User ID not available yet for loading settings.");
                return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const settings = await window.firestoreGetDoc(userSettingsPath, 'userProfile');
            if (settings) {
                document.getElementById('displayName').value = settings.displayName || '';
                document.getElementById('email').value = settings.email || '';
                document.getElementById('defaultDeploymentZone').value = settings.defaultDeploymentZone || 'Global Quantum Grid';
                document.getElementById('autoVaultClaimSetting').value = settings.autoVaultClaim || 'yes';
            } else {
                // If settings document doesn't exist, set initial values
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', {
                    displayName: "QuantumEngineer001",
                    email: "quantum.user@example.com",
                    defaultDeploymentZone: "Global Quantum Grid",
                    autoVaultClaim: "yes"
                });
                loadSettings(); // Reload after setting defaults
            }

            // Render DNS records and quantum channels from Firestore
            renderDnsRecords();
            renderQuantumChannels();
            renderQuantumNodes();
            renderSettingsCompanySelection(); // Render company selection for settings
        }

        // Save User Profile
        async function saveUserProfile() {
            if (window.getUserId() === 'loading') {
                window.showCustomModal('Error', 'User not authenticated yet. Please wait.', true);
                return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const displayName = document.getElementById('displayName').value;
            const email = document.getElementById('email').value;
            try {
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', { displayName, email });
                window.showCustomModal('Profile Updated!', 'Your display name and email have been saved.', true);
            } catch (error) {
                window.showCustomModal('Save Error', `Failed to save profile: ${error.message}`, true);
            }
        }
        window.saveUserProfile = saveUserProfile; // Expose globally

        // Save Protocol Preferences
        async function saveProtocolPreferences() {
            if (window.getUserId() === 'loading') {
                window.showCustomModal('Error', 'User not authenticated yet. Please wait.', true);
                return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const defaultDeploymentZone = document.getElementById('defaultDeploymentZone').value;
            const autoVaultClaim = document.getElementById('autoVaultClaimSetting').value;
            try {
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', { defaultDeploymentZone, autoVaultClaim }, { merge: true }); // Merge to not overwrite other profile data
                window.showCustomModal('Preferences Saved!', 'Your protocol preferences have been updated.', true);
            }
            catch (error) {
                window.showCustomModal('Save Error', `Failed to save preferences: ${error.message}`, true);
            }
        }
        window.saveProtocolPreferences = saveProtocolPreferences; // Expose globally


        // Settings Tab Navigation Logic
        function showSettingsTab(tabId) {
            // Hide all sub-views
            document.querySelectorAll('.settings-sub-view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show the selected sub-view
            document.getElementById(`settings-${tabId}`).classList.remove('hidden');

            // Update active button state
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                if (btn.getAttribute('data-settings-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render domain/email/dns data if switching to that tab
            if (tabId === 'domains') {
                renderDnsRecords();
                renderQuantumChannels();
                renderQuantumNodes();
                renderSettingsCompanySelection(); // Ensure selection is rendered on tab switch
            }
        }
        window.showSettingsTab = showSettingsTab; // Make global for direct calls from HTML

        // Render DNS Records (from Firestore)
        function renderDnsRecords() {
            const dnsTableBody = document.getElementById('dnsRecordsTableBody');
            if (!dnsTableBody) return;
            dnsTableBody.innerHTML = '';
            
            if (FAA_QUANTUM_DATA.dnsRecords.length === 0) {
                dnsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400">No DNS records found.</td></tr>';
            }

            FAA_QUANTUM_DATA.dnsRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold">${record.type}</td>
                    <td>${record.name}</td>
                    <td>${record.value}</td>
                    <td>${record.ttl}</td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit DNS', 'Edit functionality for ${record.name} coming soon! (Simulation)')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="deleteDnsRecord('${record.id}')">Delete</button>
                    </td>
                `;
                dnsTableBody.appendChild(row);
            });
        }

        // Add DNS Record (Simulated via Firestore addDoc)
        async function addDnsRecord() {
            const type = prompt("Enter DNS Record Type (e.g., A, CNAME, TXT):");
            if (!type) return;
            const name = prompt("Enter DNS Record Name (e.g., @, quantum.subdomain):");
            if (!name) return;
            const value = prompt("Enter DNS Record Value:");
            if (!value) return;
            const ttl = prompt("Enter TTL (e.g., Auto, 3600):", "Auto");

            if (type && name && value) {
                const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
                try {
                    await window.firestoreAddDoc(publicDnsRecordsPath, { type, name, value, ttl });
                    window.showCustomModal('DNS Record Added', `Record "${name}" (${type}) added successfully.`, true);
                } catch (error) {
                    window.showCustomModal('Error', `Failed to add DNS record: ${error.message}`, true);
                }
            } else {
                window.showCustomModal('Input Required', 'All fields (Type, Name, Value) are required.', true);
            }
        }
        window.addDnsRecord = addDnsRecord; // Expose globally

        // Delete DNS Record (Simulated via Firestore deleteDoc)
        async function deleteDnsRecord(docId) {
            if (confirm("Are you sure you want to delete this DNS record?")) {
                const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
                try {
                    // Correct usage of deleteDoc with doc reference
                    await window.deleteDoc(doc(window.firestoreDb, publicDnsRecordsPath, docId));
                    window.showCustomModal('DNS Record Deleted', 'Record deleted successfully.', true);
                } catch (error) {
                    console.error("Error deleting DNS record:", error);
                    window.showCustomModal('Error', `Failed to delete DNS record: ${error.message}`, true);
                }
            }
        }
        window.deleteDnsRecord = deleteDnsRecord; // Expose globally


        // Render Quantum Nodes (renamed from Domains, from Firestore)
        function renderQuantumNodes() {
            const nodeList = document.getElementById('nodeList');
            const addonNodeTargetSelect = document.getElementById('addonNodeTarget');
            if (!nodeList || !addonNodeTargetSelect) return;
            
            nodeList.innerHTML = ''; // Clear existing
            addonNodeTargetSelect.innerHTML = '<option value="">Select Primary Node</option>';

            if (FAA_QUANTUM_DATA.quantumNodes.length === 0) {
                nodeList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No quantum nodes found.</p>';
            }

            FAA_QUANTUM_DATA.quantumNodes.forEach(node => {
                const listItem = document.createElement('li');
                const statusIcon = node.type.includes('Pending') ? 'fas fa-hourglass-half text-yellow-500' : 'fas fa-check-circle text-green-500';
                listItem.innerHTML = `<i class="${statusIcon} mr-2"></i> ${node.name} (${node.type})`;
                nodeList.appendChild(listItem);

                // Populate add-on node select only with primary/active nodes
                if (node.type.includes('Primary') || node.type.includes('Subnode')) {
                    const option = document.createElement('option');
                    option.value = node.name;
                    option.textContent = node.name;
                    addonNodeTargetSelect.appendChild(option);
                }
            });
        }

        // Add Node (Simulated via Firestore addDoc)
        async function addNode() {
            const newNodeName = document.getElementById('newNodeName').value.trim();
            if (!newNodeName) {
                window.showCustomModal('Input Required', 'Please enter a quantum node name.', true);
                return;
            }
            const publicQuantumNodesPath = `artifacts/${APP_ID}/public/data/quantumNodes`;
            try {
                await window.firestoreAddDoc(publicQuantumNodesPath, { name: newNodeName, type: 'Primary' });
                window.showCustomModal('Quantum Node Added', `Node "${newNodeName}" added successfully.`, true);
                document.getElementById('newNodeName').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to add node: ${error.message}`, true);
            }
        }
        window.addNode = addNode; // Expose globally

        // Add Add-on Node (Simulated via Firestore addDoc)
        async function addAddonNode() {
            const newAddonNodeName = document.getElementById('newAddonNodeName').value.trim();
            const addonNodeTarget = document.getElementById('addonNodeTarget').value;
            if (!newAddonNodeName || !addonNodeTarget) {
                window.showCustomModal('Input Required', 'Please enter both add-on node and select a primary node.', true);
                return;
            }
            const publicQuantumNodesPath = `artifacts/${APP_ID}/public/data/quantumNodes`;
            try {
                await window.firestoreAddDoc(publicQuantumNodesPath, { name: `${newAddonNodeName}.${addonNodeTarget}`, type: 'Subnode' });
                window.showCustomModal('Add-on Node Added', `Add-on node "${newAddonNodeName}.${addonNodeTarget}" added successfully.`, true);
                document.getElementById('newAddonNodeName').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to add add-on node: ${error.message}`, true);
            }
        }
        window.addAddonNode = addAddonNode; // Expose globally


        // Render Quantum Channels (renamed from Email Accounts, from Firestore)
        function renderQuantumChannels() {
            const quantumChannelsTableBody = document.getElementById('quantumChannelsTableBody');
            if (!quantumChannelsTableBody) return;
            quantumChannelsTableBody.innerHTML = '';
            
            if (FAA_QUANTUM_DATA.quantumChannels.length === 0) {
                quantumChannelsTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">No quantum channels found.</td></tr>';
            }

            FAA_QUANTUM_DATA.quantumChannels.forEach(channel => {
                const row = document.createElement('tr');
                const statusClass = channel.status === 'Active' ? 'text-green-500' : 'text-yellow-500';
                row.innerHTML = `
                    <td class="font-semibold">${channel.address}</td>
                    <td><span class="${statusClass}">${channel.status}</span></td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit Channel', 'Edit channel ${channel.address} functionality coming soon! (Simulation)')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="deleteQuantumChannel('${channel.id}')">Delete</button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2 ml-2" onclick="window.openChannelDraftModal('${channel.address}')">
                            <i class="fas fa-envelope"></i> âœ¨ Draft Message
                        </button>
                    </td>
                `;
                quantumChannelsTableBody.appendChild(row);
            });
        }

        // Create Quantum Channel (Simulated via Firestore addDoc)
        async function createChannel() {
            const newChannelPrefix = document.getElementById('newChannelPrefix').value.trim();
            const newChannelDomain = document.getElementById('newChannelDomain').value.trim();
            if (!newChannelPrefix || !newChannelDomain) {
                window.showCustomModal('Input Required', 'Please enter both channel prefix and domain.', true);
                return;
            }
            const newChannel = `${newChannelPrefix}@${newChannelDomain}`;
            const publicQuantumChannelsPath = `artifacts/${APP_ID}/public/data/quantumChannels`;
            try {
                await window.firestoreAddDoc(publicQuantumChannelsPath, { address: newChannel, status: 'Pending Activation' });
                window.showCustomModal('Quantum Channel Created', `Channel "${newChannel}" created successfully. Activation pending.`, true);
                document.getElementById('newChannelPrefix').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to create channel: ${error.message}`, true);
            }
        }
        document.getElementById('createChannelBtn')?.addEventListener('click', createChannel);


        // Delete Quantum Channel (Simulated via Firestore deleteDoc)
        async function deleteQuantumChannel(docId) {
            if (confirm("Are you sure you want to delete this quantum channel?")) {
                const publicQuantumChannelsPath = `artifacts/${APP_ID}/public/data/quantumChannels`;
                try {
                    await window.deleteDoc(doc(window.firestoreDb, publicQuantumChannelsPath, docId));
                    window.showCustomModal('Channel Deleted', 'Quantum channel deleted successfully.', true);
                } catch (error) {
                    console.error("Error deleting quantum channel:", error);
                    window.showCustomModal('Error', `Failed to delete quantum channel: ${error.message}`, true);
                }
            }
        }
        window.deleteQuantumChannel = deleteQuantumChannel; // Expose globally

        // Render company selection cards for settings panel
        function renderSettingsCompanySelection() {
            const settingsCompanySelectionGrid = document.getElementById('settingsCompanySelectionGrid');
            if (settingsCompanySelectionGrid) {
                settingsCompanySelectionGrid.innerHTML = ''; // Clear previous selections
                const quantumCompanies = Object.entries(companyData).filter(([key, company]) => company.sector_key === "quantum");

                if (quantumCompanies.length === 0) {
                    settingsCompanySelectionGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full">No company data found for the Quantum Protocols sector.</p>';
                }

                quantumCompanies.forEach(([key, company]) => {
                    const card = document.createElement('div');
                    card.className = 'company-select-card p-4 rounded-lg text-center shadow-md cursor-pointer bg-gray-700 hover:bg-gray-600 border border-gray-600'; // Added styling classes
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-white">${company.name}</h3>
                        <p class="text-gray-400 text-xs">Sector: ${sectorList[company.sector_key].name}</p>
                    `;
                    card.onclick = () => window.renderSettingsCompanyDetails(key);
                    settingsCompanySelectionGrid.appendChild(card);
                });
            }
        }

        // Render detailed company information in settings
        window.renderSettingsCompanyDetails = function(companyKey) {
            const company = companyData[companyKey];
            const detailsOutput = document.getElementById('settingsCompanyDetailsOutput');
            if (!company || !detailsOutput) return;

            detailsOutput.innerHTML = `
                <h4 class="text-xl font-bold mb-4 text-white">${company.name} Infrastructure Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                    ${Object.entries(company.details).map(([key, value]) => `
                        <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                            <strong class="text-orange-400">${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
                <button class="form-action-button mt-4 bg-red-600 hover:bg-red-700" onclick="showCustomModal('Simulation', 'Advanced company management tools for quantum infrastructure coming soon!', true)">
                    <i class="fas fa-cogs mr-1"></i> Manage Quantum Infrastructure
                </button>
            `;
            detailsOutput.classList.remove('hidden');
        };

        // --- Template Preview Modal Logic (adapted for Quantum) ---
        window.showTemplatePreviewModal = function(template) {
            const modal = document.getElementById('templatePreviewModal');
            const previewTitle = document.getElementById('templatePreviewTitle');
            const previewFrame = document.getElementById('templatePreviewFrame');
            const previewDescription = document.getElementById('templatePreviewDescription');
            const useTemplateNewProtocolBtn = document.getElementById('useTemplateNewProjectBtn');
            const useTemplateScrollBuilderBtn = document.getElementById('useTemplateScrollBuilderBtn'); // Renamed

            if (!modal || !previewTitle || !previewFrame || !previewDescription || !useTemplateNewProtocolBtn || !useTemplateScrollBuilderBtn) return;

            previewTitle.textContent = template.name;
            previewDescription.textContent = template.description;
            
            // Set iframe srcdoc with the template's preview HTML
            previewFrame.srcdoc = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Preview</title>
                    <style>
                        /* Common preview styles, ensure colors match the current dashboard theme (light/dark) */
                        body { 
                            font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; text-align: center; 
                            background-color: ${document.body.classList.contains('light-mode') ? '#f8f8f8' : '#1a1a1c'}; 
                            color: ${document.body.classList.contains('light-mode') ? '#1d1d1f' : '#f5f5f7'};
                        }
                        h1 { 
                            font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem;
                            color: #ff8c00; /* Primary Quantum color */
                        }
                        h1 span {
                            color: #0071e3; /* Accent blue */
                        }
                        h2 { 
                            font-size: 1.2rem; color: ${document.body.classList.contains('light-mode') ? '#4a4a4a' : '#a0a0a5'}; margin-bottom: 1.5rem; 
                        }
                        p { 
                            font-size: 0.95rem; line-height: 1.5; 
                            color: ${document.body.classList.contains('light-mode') ? '#6e6e73' : '#b0b0b0'}; 
                        }
                        button { 
                            background-color: #0071e3; 
                            color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;
                        }
                        audio, video {
                            width: 80%;
                            max-width: 400px;
                            margin: 1.5rem auto;
                            display: block;
                        }
                        iframe {
                            width: 100%;
                            height: 250px;
                            margin-top: 1.5rem;
                            border-radius: 8px;
                            border: 1px solid #3a3a3e;
                        }
                    </style>
                </head>
                <body>
                    ${template.htmlCode}
                </body>
                </html>
            `;
            
            // Set up action buttons to select template in forms
            useTemplateNewProtocolBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                showView('new-protocol');
                const selectElement = document.querySelector('#new-protocol-view #protocolType');
                if (selectElement) { selectElement.value = template.name; } // Set value to template name
            };

            useTemplateScrollBuilderBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                window.showCustomModal('Feature Not Fully Implemented', 'This feature is currently in development. Please select the template in the Protocol Builder manually.', true); // Informative message
                // showView('protocol-builder'); // If a protocol builder view existed
            };


            modal.classList.add('active'); // Show modal with animation
        };

        window.hideTemplatePreviewModal = function() {
            document.getElementById('templatePreviewModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Simplify Agreement Modal Logic ---
        window.showSimplifyAgreementModal = function(title, simplifiedText) {
            const modal = document.getElementById('simplifyAgreementModal');
            const modalTitle = document.getElementById('simplifyAgreementTitle');
            const modalText = document.getElementById('simplifiedAgreementText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = simplifiedText; // Use innerHTML to allow for formatting
                modal.classList.add('active'); // Show modal with animation
            }
        };

        window.hideSimplifyAgreementModal = function() {
            document.getElementById('simplifyAgreementModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Protocol Idea Modal Logic ---
        window.showProtocolIdeaModal = function(protocolName, protocolDescription, suggestedType) {
            const modal = document.getElementById('protocolIdeaModal');
            const ideaProtocolName = document.getElementById('ideaProtocolName');
            const ideaProtocolDescription = document.getElementById('ideaProtocolDescription');
            const ideaSuggestedType = document.getElementById('ideaSuggestedType');
            const applyButton = document.getElementById('applyProtocolIdeaBtn');

            if (modal && ideaProtocolName && ideaProtocolDescription && ideaSuggestedType && applyButton) {
                ideaProtocolName.textContent = protocolName;
                ideaProtocolDescription.textContent = protocolDescription;
                ideaSuggestedType.textContent = suggestedType;

                applyButton.onclick = () => {
                    document.getElementById('protocolName').value = protocolName;
                    document.getElementById('protocolDescription').value = protocolDescription;
                    const typeSelect = document.getElementById('protocolType');
                    if (typeSelect) {
                        const optionExists = Array.from(typeSelect.options).some(option => option.value === suggestedType);
                        if (optionExists) {
                            typeSelect.value = suggestedType;
                        } else {
                            // If suggested type doesn't exist, select the first available or default
                            typeSelect.value = typeSelect.options[1] ? typeSelect.options[1].value : ""; 
                            window.showCustomModal('Type Not Found', `"${suggestedType}" protocol type not found. Selected a default.`, true);
                        }
                    }
                    window.hideProtocolIdeaModal();
                };

                modal.classList.add('active');
            }
        };

        window.hideProtocolIdeaModal = function() {
            document.getElementById('protocolIdeaModal')?.classList.remove('active');
        };

        // --- Protocol Summary Modal (NEW) ---
        window.showProtocolSummaryModal = function(title, summaryText) {
            const modal = document.getElementById('protocolSummaryModal');
            const modalTitle = document.getElementById('protocolSummaryTitle');
            const modalText = document.getElementById('protocolSummaryText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = summaryText; // Use innerHTML to allow for formatting
                modal.classList.add('active');
            }
        };

        window.hideProtocolSummaryModal = function() {
            document.getElementById('protocolSummaryModal')?.classList.remove('active');
        };

        // --- Anomaly Investigator Modal (NEW) ---
        window.showAnomalyInvestigatorModal = function(title, investigationOutput) {
            const modal = document.getElementById('anomalyInvestigatorModal');
            const modalTitle = document.getElementById('anomalyInvestigatorTitle');
            const anomalyReportText = document.getElementById('anomalyReportText');
            const anomalyInvestigationOutput = document.getElementById('anomalyInvestigationOutput');

            if (modal && modalTitle && anomalyReportText && anomalyInvestigationOutput) {
                modalTitle.textContent = `Anomaly Investigation: ${title}`;
                anomalyReportText.textContent = `Reported Anomaly: ${title}`;
                anomalyInvestigationOutput.innerHTML = investigationOutput;
                modal.classList.add('active');
            }
        };

        window.hideAnomalyInvestigatorModal = function() {
            document.getElementById('anomalyInvestigatorModal')?.classList.remove('active');
        };

        // --- Channel Draft Modal (NEW) ---
        let currentChannelForDraft = ''; // Store the channel being drafted for

        window.openChannelDraftModal = function(channelAddress) {
            currentChannelForDraft = channelAddress;
            const modal = document.getElementById('channelDraftModal');
            const modalTitle = document.getElementById('channelDraftTitle');
            const channelDraftTo = document.getElementById('channelDraftTo');
            const channelPurposeInput = document.getElementById('channelPurposeInput');
            const generatedChannelDraftOutput = document.getElementById('generatedChannelDraftOutput');
            const channelDraftStatus = document.getElementById('channelDraftStatus');

            if (modal && modalTitle && channelDraftTo && channelPurposeInput && generatedChannelDraftOutput && channelDraftStatus) {
                modalTitle.textContent = `Draft Message for ${channelAddress}`;
                channelDraftTo.textContent = channelAddress;
                channelPurposeInput.value = ''; // Clear previous input
                generatedChannelDraftOutput.value = ''; // Clear previous draft
                channelDraftStatus.classList.add('hidden'); // Hide status
                modal.classList.add('active');
            }
        };

        window.hideChannelDraftModal = function() {
            document.getElementById('channelDraftModal')?.classList.remove('active');
            currentChannelForDraft = ''; // Clear stored channel
        };


        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, ensure all CSS custom properties are computed and stored in FAA_QUANTUM_DATA.colors
            // This needs to happen BEFORE any charts or elements that rely on these colors are rendered.
            const rootStyles = getComputedStyle(document.documentElement);
            FAA_QUANTUM_DATA.colors.primary = rootStyles.getPropertyValue('--primary-color').trim();
            FAA_QUANTUM_DATA.colors.secondary = rootStyles.getPropertyValue('--secondary-color').trim();
            FAA_QUANTUM_DATA.colors.textDark = rootStyles.getPropertyValue('--text-color-dark').trim();
            FAA_QUANTUM_DATA.colors.borderColorDark = rootStyles.getPropertyValue('--border-color-dark').trim();
            FAA_QUANTUM_DATA.colors.accentGold = rootStyles.getPropertyValue('--accent-gold').trim();

            // Set up sidebar navigation clicks
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    const viewId = e.currentTarget.getAttribute('data-view');
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });

            // Set up settings tab clicks
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.getAttribute('data-settings-tab');
                    showSettingsTab(tabId);
                });
            });


            // Set the initial view based on hash or default to dashboard
            const initialView = window.location.hash.substring(1) || 'dashboard';
            showView(initialView);

            // Populate protocol type dropdowns initially
            populateProtocolTypeSelects();
            
            // Setup DNS Explain button listener
            document.getElementById('explainDnsBtn')?.addEventListener('click', async (event) => {
                const dnsType = document.getElementById('dnsRecordTypeInput').value.trim();
                const button = event.currentTarget;
                if (!dnsType) {
                    window.showCustomModal('Input Required', 'Please enter a DNS record type (e.g., A, CNAME, TXT) to explain.');
                    return;
                }
                const prompt = `Explain what a "${dnsType}" DNS record is, its primary purpose in quantum networking, and a typical use case for routing quantum data. Keep the explanation concise and easy to understand for a non-expert.`;
                await window.callGeminiAPI(prompt, 'dnsExplanationOutput', 'dnsExplainStatus', button, 'Explain DNS Type');
            });

            // Event listener for Generate Channel Draft Button (NEW)
            document.getElementById('generateChannelDraftBtn')?.addEventListener('click', async (event) => {
                const channelPurpose = document.getElementById('channelPurposeInput').value.trim();
                const button = event.currentTarget;
                if (!channelPurpose) {
                    window.showCustomModal('Input Required', 'Please enter a purpose for the channel message.');
                    return;
                }
                const prompt = `Draft a professional message (max 200 words) for the purpose of "${channelPurpose}" from the quantum channel address "${currentChannelForDraft}". Focus on a clear and concise tone for a quantum protocols audience. Provide only the message body.`;
                await window.callGeminiAPI(prompt, 'generatedChannelDraftOutput', 'channelDraftStatus', button, 'Draft Channel Message');
            });


            // Theme toggle logic
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    const isLightMode = document.body.classList.contains('light-mode');
                    themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                    
                    // Re-render charts to update colors based on new theme
                    renderViewContent(window.location.hash.substring(1) || 'dashboard');
                });
                // Set initial icon based on default theme
                const isLightMode = document.body.classList.contains('light-mode');
                themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        });

        // Helper function to populate protocol type dropdowns
        function populateProtocolTypeSelects() {
            const newProtocolTypeSelect = document.querySelector('#new-protocol-view #protocolType');
            if(newProtocolTypeSelect) {
                newProtocolTypeSelect.innerHTML = FAA_QUANTUM_DATA.protocols.types.map(type => `<option value="${type}">${type}</option>`).join('');
                newProtocolTypeSelect.insertAdjacentHTML('afterbegin', '<option value="">Select a protocol type...</option>');
                newProtocolTypeSelect.value = ""; // Default empty
            }
        }
    </script>
</body>
</html>
